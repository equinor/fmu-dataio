<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dataio.dataio &mdash; fmu.dataio 0.10.3.dev5+ga28cb9f documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/togglebutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script>let toggleHintShow = 'Expand';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #C0C0C0" >
            <a href="../../index.html" class="icon icon-home"> fmu.dataio
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref/modules.html">API reference for fmu.dataio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datamodel.html">The FMU results data model</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #C0C0C0" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fmu.dataio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>dataio.dataio</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dataio.dataio</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for DataIO class.</span>

<span class="sd">The metadata spec is documented as a JSON schema, stored under schema/.</span>

<span class="sd">The processing is based on handling first level keys which are</span>

<span class="sd">* Scalar special::</span>

<span class="sd">    $schema      |</span>
<span class="sd">    version      |     hard set in code, corresponding to schema version</span>
<span class="sd">    source       |</span>

<span class="sd">* ``class``        - determined by datatype, inferred</span>

<span class="sd">* Nested attributes::</span>

<span class="sd">    file         - information about the data object origin as file on disk</span>
<span class="sd">    tracklog     - events recorded on these data</span>
<span class="sd">    data         - about the data (see class). Inferred from input, data + fmuconfig</span>
<span class="sd">    display      - Deduced mostly from fmuconfig (TODO: issue on wait)</span>
<span class="sd">    fmu          - Deduced from fmuconfig and ERT</span>
<span class="sd">    access       - Govern permissions for exported data, infer from fmuconfig or args</span>
<span class="sd">    masterdata   - Static, infer from fmuconfig</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">deprecation</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_utils</span>
<span class="kn">from</span> <span class="nn">._export_item</span> <span class="kn">import</span> <span class="n">_ExportItem</span>
<span class="kn">from</span> <span class="nn">.version</span> <span class="kn">import</span> <span class="n">version</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>

<span class="c1"># the word &quot;DOLLARS&quot; refers losely to $schema and related keys (version, source)</span>
<span class="n">DOLLARS</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;$schema&quot;</span><span class="p">,</span>
            <span class="s2">&quot;https://main-fmu-schemas-dev.radix.equinor.com/schemas/0.8.0/&quot;</span>
            <span class="s2">&quot;fmu_results.json&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;0.8.0&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fmu&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="c1"># ######################################################################################</span>
<span class="c1"># ExportData</span>
<span class="c1"># ######################################################################################</span>


<div class="viewcode-block" id="ExportData"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData">[docs]</a><span class="k">class</span> <span class="nc">ExportData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for exporting data with rich metadata in FMU.</span>

<span class="sd">    This class sets up the general metadata content to be applied in export. The idea</span>
<span class="sd">    is that one ExportData instance can be re-used for several similar export() jobs.</span>
<span class="sd">    For example::</span>

<span class="sd">        edata = dataio.ExportData(</span>
<span class="sd">            config=CFG,</span>
<span class="sd">            content=&quot;depth&quot;,</span>
<span class="sd">            unit=&quot;m&quot;,</span>
<span class="sd">            vertical_domain={&quot;depth&quot;: &quot;msl&quot;},</span>
<span class="sd">            timedata=None,</span>
<span class="sd">            is_prediction=True,</span>
<span class="sd">            is_observation=False,</span>
<span class="sd">            tagname=&quot;faultlines&quot;,</span>
<span class="sd">            workflow=&quot;rms structural model&quot;,</span>
<span class="sd">        )</span>

<span class="sd">        for name in [&quot;TopOne&quot;, TopTwo&quot;, &quot;TopThree&quot;]:</span>
<span class="sd">            poly = xtgeo.polygons_from_roxar(PRJ, hname, POL_FOLDER)</span>
<span class="sd">            out = ed.export(poly, name=name)</span>

<span class="sd">    Some keyword settings like ``name``, ``tagname`` etc can be set in both the</span>
<span class="sd">    ExportData instance and directly in the ``export()`` function, to provide</span>
<span class="sd">    flexibility for different use cases. If both are set, the ``export()`` setting</span>
<span class="sd">    will win.</span>


<span class="sd">    Args:</span>
<span class="sd">        runpath: The relative location of the current run root. This is optional and</span>
<span class="sd">            will in most cased be auto-detected, assuming that FMU folder conventions</span>
<span class="sd">            are followed. For an ERT run e.g. /scratch/xx/nn/case/realization-0/iter-0/.</span>
<span class="sd">            while in a revision at project disc it will the revision root e.g.</span>
<span class="sd">            /project/xx/resmod/ff/21.1.0/.</span>
<span class="sd">        context: [EXPERIMENTAL] The context of the object with respect to</span>
<span class="sd">            itself and/or other stratigraphic units. The default is None, but for</span>
<span class="sd">            e.g. seismic attributes this can be important. The input is a</span>
<span class="sd">            dictionary with the following fields: [TODO]</span>
<span class="sd">        config: A configuation dictionary. In the standard case this is read</span>
<span class="sd">            from FMU global variables (via fmuconfig). The dictionary must contain</span>
<span class="sd">            some predefined main level keys to work with fmu-dataio. If the key is</span>
<span class="sd">            missing or key value is None, then it will look for the environment variable</span>
<span class="sd">            FMU_GLOBAL_CONFIG to detect the file. If no success in finding the file,</span>
<span class="sd">            a UserWarning is made.</span>
<span class="sd">        content: Is a string or a dictionary with one key. Example is &quot;depth&quot; or</span>
<span class="sd">            {&quot;fluid_contact&quot;: {&quot;xxx&quot;: &quot;yyy&quot;, &quot;zzz&quot;: &quot;uuu&quot;}}</span>
<span class="sd">        subfolder: It is possible to set one level of subfolders for file output.</span>
<span class="sd">        include_index: This applies to Pandas (table) data only, and if True then the</span>
<span class="sd">            index column will be exported.</span>
<span class="sd">        vertical_domain: This is dictionary with a key and a reference e.g.</span>
<span class="sd">            {&quot;depth&quot;: &quot;msl&quot;} which is default (if None is input)</span>
<span class="sd">        timedata: If given, a list of lists with dates, .e.g.</span>
<span class="sd">            [[20200101, &quot;monitor&quot;], [20180101, &quot;base&quot;]] or just [[20210101]]</span>
<span class="sd">        is_prediction: True (default) of model prediction data</span>
<span class="sd">        is_observation: Default is False. If True, then disk storage will be on the</span>
<span class="sd">            &quot;share/observations&quot; folder</span>
<span class="sd">        workflow: Short tag desciption of workflow (as description)</span>
<span class="sd">        casepath: Absolute path to the case root. If not provided, it will be attempted</span>
<span class="sd">            parsed from the file structure.</span>

<span class="sd">        name: The name of the object. If not set it is tried to be inferred from</span>
<span class="sd">            the xtgeo/pandas/... object. The name is then checked towards the</span>
<span class="sd">            stratigraphy list, and name is replaced with official stratigraphic</span>
<span class="sd">            name if found in static metadata `stratigraphy`. For example, if</span>
<span class="sd">            &quot;TopValysar&quot; is the model name and the actual name</span>
<span class="sd">            is &quot;Valysar Top Fm.&quot; that latter name will be used.</span>
<span class="sd">        unit: Is the unit of the exported item(s), e.g. &quot;m&quot; or &quot;fraction&quot;.</span>
<span class="sd">        parent: This key is required for datatype GridProperty, and refers to the</span>
<span class="sd">            name of the grid geometry.</span>
<span class="sd">        tagname: This is a short tag description which be be a part of file name.</span>
<span class="sd">        description: A multiline description of the data.</span>
<span class="sd">        access_ssdl: A dictionary that will overwrite or append to the default ssdl</span>
<span class="sd">            settings read from the config. Example:</span>
<span class="sd">            ``{&quot;access_level&quot;: &quot;restricted&quot;, &quot;rep_include&quot;: False}``</span>
<span class="sd">        display_name: Set name for clients to use when visualizing.</span>

<span class="sd">        verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">            in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;.</span>
<span class="sd">        **kwargs: For special developer settings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">surface_fformat</span> <span class="o">=</span> <span class="s2">&quot;irap_binary&quot;</span>
    <span class="n">table_fformat</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="n">arrow_fformat</span> <span class="o">=</span> <span class="s2">&quot;arrow&quot;</span>
    <span class="n">polygons_fformat</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>  <span class="c1"># or use &quot;csv|xtgeo&quot; to avoid renaming of xtgeo columns</span>
    <span class="n">points_fformat</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>  <span class="c1"># or use &quot;csv|xtgeo&quot; to avoid renaming of xtgeo columns</span>
    <span class="n">grid_fformat</span> <span class="o">=</span> <span class="s2">&quot;roff&quot;</span>
    <span class="n">cube_fformat</span> <span class="o">=</span> <span class="s2">&quot;segy&quot;</span>

    <span class="c1"># this is case folder which is &quot;outside runs&quot; i.e. another relative!</span>
    <span class="c1"># e.g. /somepath/mycase/share/metadata</span>
    <span class="n">case_folder</span> <span class="o">=</span> <span class="s2">&quot;share/metadata&quot;</span>

    <span class="n">createfolder</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">meta_format</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">runpath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">access_ssdl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_observation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">subfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timedata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">vertical_domain</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">workflow</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># the following keys can be overridden in the export() function:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tagname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># developer options</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># kwargs:</span>
        <span class="c1">#    runfolder: Override _pwd (process working directory) and this a developer</span>
        <span class="c1">#        developer setting when running tests e.g. in pytest&#39;s tmp_path</span>
        <span class="c1">#    dryrun: Set instance variables but do not run functions (for unit testing)</span>
        <span class="c1">#    inside_rms: If forced to true then pretend to be in rms env.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="o">=</span> <span class="n">runpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_ssdl</span> <span class="o">=</span> <span class="n">access_ssdl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_get</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_prediction</span> <span class="o">=</span> <span class="n">is_prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_observation</span> <span class="o">=</span> <span class="n">is_observation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timedata</span> <span class="o">=</span> <span class="n">timedata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vertical_domain</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;msl&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="n">vertical_domain</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">vertical_domain</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subfolder</span> <span class="o">=</span> <span class="n">subfolder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_index</span> <span class="o">=</span> <span class="n">include_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span> <span class="o">=</span> <span class="n">workflow</span>

        <span class="c1"># the following may change quickly in e.g. a loop and can be overridden</span>
        <span class="c1"># in export():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tagname</span> <span class="o">=</span> <span class="n">tagname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_name</span> <span class="o">=</span> <span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit</span> <span class="o">=</span> <span class="n">unit</span>

        <span class="c1"># keep track of case</span>
        <span class="c1"># TODO: Need to differentiate the different usages of &quot;case&quot;</span>
        <span class="c1"># Here, the _case refers to case metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># keep track of this is an FMU run or not. FMU run here refers to the FORWARD</span>
        <span class="c1"># context (realization ran by ERT)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fmurun</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># store placeholder for ERT information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ert</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># store iter and realization names, paths and ids (when running ERT)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_itername</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># name of the folder, e.g. &quot;iter-0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_realname</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># name of the folder, e.g. &quot;realization-0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iterpath</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># path to the iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_realpath</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># path to the realization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># id of the iteration, e.g. &quot;0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_realization_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># id of the realization, e.g. &quot;0&quot;</span>

        <span class="c1"># store case root and uuid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># run private method for processing the pwd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_pwd_runpath</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># define chunks of metadata for primary first order categories</span>
        <span class="c1"># (except class which is set directly later)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4dollars</span> <span class="o">=</span> <span class="n">DOLLARS</span>  <span class="c1"># schema, version, source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4file</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># file (to be populated in export job)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4tracklog</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># tracklog:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># data:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4display</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># display:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># access:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4masterdata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># masterdata:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># fmu:</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dryrun&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># developer option, for tests</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dry run mode is active for __init__&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># strat metadata are used as componenents in some of the other meta keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_strat</span><span class="p">()</span>

        <span class="c1"># Get the metadata for some of the general stuff, fully or partly</span>
        <span class="c1"># Note that data and display are found later (e.g. in _export_item)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_masterdata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_access</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_tracklog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_meta_fmu</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create instance of ExportData&quot;</span><span class="p">)</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Private attributes that are or may be exposed read-only for other classes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runpath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return runpath which is the relative path to run root folder.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return context.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return content.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return config.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subfolder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return subfolder name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subfolder</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">include_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return include_index boolean.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_index</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vertical_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return domain dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vertical_domain</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timedata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return timedata.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timedata</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return is_prediction boolean.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_prediction</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return is_observation boolean.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_observation</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return workflow string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">itername</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return itername string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itername</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">realname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return realname string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return pwd Path object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Private utility methods</span>

    <span class="k">def</span> <span class="nf">_process_pwd_runpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process self._pwd and self._runpath&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>  <span class="c1"># process working directory</span>

        <span class="c1"># developer option (for testing): set another pwd</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;runfolder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;runfolder&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initial RUNPATH is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Inside RMS status (developer setting) is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inside_rms&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># Context 1: Running RMS, we are in conventionally in RUNPATH/rms/model</span>
        <span class="c1"># Context 2: ERT FORWARD_JOB, running at RUNPATH level</span>
        <span class="c1"># Context 3: ERT WORKFLOW_JOB, running somewhere/anywhere else</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The runpath is hard set as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inside_rms&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Note that runfolder in this case need to be set, pretending to be in the</span>
            <span class="c1"># rms/model folder. This is merely a developer setting when running pytest</span>
            <span class="c1"># in tmp_path!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">/</span> <span class="s2">&quot;../../.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pretend to run from inside RMS&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="s2">&quot;rms&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
            <span class="ow">and</span> <span class="s2">&quot;komodo&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
        <span class="p">):</span>
            <span class="c1"># this is the case when running RMS which happens in runpath/rms/model</span>
            <span class="c1"># menaing that actual root runpath is at ../..</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../../.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Detect &#39;inside RMS&#39; from &#39;rms&#39; being in sys.executable&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;RUN_DATAIO_EXAMPLES&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>  <span class="c1"># special; for repo doc examples!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;../../.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Assuming RUNPATH at PWD which is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current RUNPATH is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runpath</span><span class="p">))</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Private metadata methods which retrieve metadata that are not closely linked to</span>
    <span class="c1"># the actual instance to be exported.</span>

    <span class="k">def</span> <span class="nf">_config_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the config.</span>

<span class="sd">        Config can be provided directly as dictionary in arguments, and will take</span>
<span class="sd">        presendence if provided. If not provided, fall-back is to look for pointer</span>
<span class="sd">        to a config file in environment variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">args_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Config is not given as argument&quot;</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Config is given as dict in arguments&quot;</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">args_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;type of config from args was </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">args_config</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;When config is given as argument, it must be a dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_from_environment_variable</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_validate</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not get config.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">_config_from_environment_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="o">=</span><span class="s2">&quot;FMU_GLOBAL_CONFIG&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the config from environment variable.</span>

<span class="sd">        This function is only called if config SHALL be fetched from the environment</span>
<span class="sd">        variable: Raise if the environment variable is not found.</span>

<span class="sd">        Returns: config (dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;config is still None, try to get from environment variable&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">cfg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Set global config from env variable </span><span class="si">%s</span><span class="s2"> as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">cfg_path</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Environment variable </span><span class="si">%s</span><span class="s2"> was not found.&quot;</span><span class="p">,</span> <span class="n">envvar</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;No config was received. &quot;</span>
                    <span class="s2">&quot;The config must be given explicitly as an input argument, or &quot;</span>
                    <span class="s2">&quot;the environment variable </span><span class="si">%s</span><span class="s2"> must point to a valid yaml file.&quot;</span><span class="p">,</span>
                    <span class="n">envvar</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">_config_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the config.</span>

<span class="sd">        Not a full validation. For now, just check that some required</span>
<span class="sd">        keys are present in the config and raise if not.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config_required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">,</span> <span class="s2">&quot;masterdata&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">required_key</span> <span class="ow">in</span> <span class="n">config_required_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">required_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required key &#39;</span><span class="si">{</span><span class="n">required_key</span><span class="si">}</span><span class="s2">&#39; not found in config.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_masterdata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata from masterdata section in config.</span>

<span class="sd">        Having the `masterdata` as hardcoded first level in the config is intentional.</span>
<span class="sd">        If that section is missing, or config is None, return with a user warning.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;masterdata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No masterdata section present&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4masterdata</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4masterdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;masterdata&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for masterdata is set!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_access</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata overall (default) from access section in config.</span>

<span class="sd">        Access should be possible to change per object, based on user input.</span>
<span class="sd">        This is done through the access_ssdl input argument.</span>

<span class="sd">        The &quot;asset&quot; field shall come from the config. This is static information.</span>

<span class="sd">        The &quot;ssdl&quot; field can come from the config, or be explicitly given through</span>
<span class="sd">        the &quot;access_ssdl&quot; input argument. If the access_ssdl input argument is present,</span>
<span class="sd">        its contents shall take presedence.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;_get_meta_access()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># DISCUSS: Should we allow no config? Or raise when missing?</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No config is given, returning&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">a_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;asset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">a_cfg</span><span class="p">:</span>
            <span class="c1"># asset shall be present if config is used</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;access.asset&#39; field not found in the config&quot;</span><span class="p">)</span>

        <span class="c1"># initialize and populate with defaults from config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">a_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span>  <span class="c1"># shortform</span>

        <span class="c1"># if there is a config, the &#39;asset&#39; tag shall be present</span>
        <span class="n">a_meta</span><span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_cfg</span><span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;meta is now: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">a_meta</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;access.asset is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">a_meta</span><span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">])</span>

        <span class="c1"># ssdl</span>
        <span class="k">if</span> <span class="s2">&quot;ssdl&quot;</span> <span class="ow">in</span> <span class="n">a_cfg</span><span class="p">:</span>
            <span class="n">a_meta</span><span class="p">[</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_cfg</span><span class="p">[</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span>

        <span class="c1"># if input argument, expand or overwrite ssdl tag contents from config</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_ssdl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;access_ssdl has been given: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_ssdl</span><span class="p">)</span>
            <span class="n">a_meta</span><span class="p">[</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">a_meta</span><span class="p">[</span><span class="s2">&quot;ssdl&quot;</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_access_ssdl</span><span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;access has been set&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_tracklog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata for tracklog section.&quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()}</span>
        <span class="n">block</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4tracklog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for tracklog is set&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_meta_fmu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata for fmu key.&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set fmu metadata for model/workflow/...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_workflow</span><span class="p">()</span>

        <span class="c1"># fmu.element is defaulted to None. Only used in aggregations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># return now if this is exporting case metadata only</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_scratch_folder_structure</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._is_fmurun is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fmurun</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fmurun</span><span class="p">:</span>
            <span class="n">c_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_case</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_meta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">][</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._case_uuid has been set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_fmurun</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_get_ert_information</span><span class="p">()</span>

            <span class="n">i_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_iteration</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_meta</span>

            <span class="n">r_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_meta_fmu_realization</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;realization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_meta</span>

    <span class="k">def</span> <span class="nf">_get_ert_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse relevant system files from ERT&quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;parsing ERT files&quot;</span><span class="p">)</span>

        <span class="c1"># store parameters.txt</span>
        <span class="n">parameters_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterpath</span> <span class="o">/</span> <span class="s2">&quot;parameters.txt&quot;</span>
        <span class="k">if</span> <span class="n">parameters_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">read_parameters_txt</span><span class="p">(</span><span class="n">parameters_file</span><span class="p">)</span>
            <span class="n">nested_params</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">nested_parameters_dict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ert</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nested_params</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;parameters.txt parsed.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;parameters.txt was not found&quot;</span><span class="p">)</span>

        <span class="c1"># store jobs.json</span>
        <span class="n">jobs_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterpath</span> <span class="o">/</span> <span class="s2">&quot;jobs.json&quot;</span>
        <span class="k">if</span> <span class="n">jobs_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jobs_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ert</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;jobs.json parsed.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;jobs.json was not found&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ERT files has been parsed.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processing the fmu.workflow section.</span>

<span class="sd">        self._workflow can be either a str or a dict. Outgoing worklow tag in</span>
<span class="sd">        metadata shall be a dict, containing at least a &#39;reference&#39; key:</span>
<span class="sd">        &quot;workflow&quot;: {&quot;reference&quot;: &quot;MyString&quot;}.</span>

<span class="sd">        If self._workflow is provided as a string, the dictionary will be made and the</span>
<span class="sd">        string will be used as the value for the &#39;reference&#39; key.</span>

<span class="sd">        If self._workflow is provided as a dict, it shall contain the &#39;reference&#39; key.</span>
<span class="sd">        If self._workflow is provided as a dict, it will be used directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Process fmu.workflow...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow input argument is a dictionary&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;reference&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;reference&#39; key not found in workflow dictionary&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span><span class="p">[</span><span class="s2">&quot;reference&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;workflow.reference is of type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span><span class="p">[</span><span class="s2">&quot;reference&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;reference&#39; value was not a string&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Workflow input argument is a string&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">][</span><span class="s2">&quot;reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;workflow input argument was not given as dict or str&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;workflow input argument was </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workflow</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;workflow input argument is not valid&quot;</span><span class="p">)</span>

    <span class="c1"># def _process_meta_fmu_context(self):</span>
    <span class="c1">#     &quot;&quot;&quot;Processing the fmu:grid_model section&quot;&quot;&quot;</span>

    <span class="c1">#     if self._grid_model is None:</span>
    <span class="c1">#         logger.info(&quot;grid_model was None, assuming it was not passed&quot;)</span>
    <span class="c1">#         return</span>

    <span class="c1">#     meta = self._grid_model</span>

    <span class="c1">#     if not isinstance(meta, dict):</span>
    <span class="c1">#         logger.error(&quot;grid_model: %s&quot;, str(meta))</span>
    <span class="c1">#         logger.debug(&quot;grid_model type was %s&quot;, str(type(meta)))</span>
    <span class="c1">#         raise ValueError(&quot;The grid_model argument must be of type dict&quot;)</span>

    <span class="c1">#     if &quot;name&quot; not in meta.keys():</span>
    <span class="c1">#         logger.error(&quot;grid_model: %s&quot;, str(meta))</span>
    <span class="c1">#         logger.debug(&quot;keys in meta: %s&quot;, str(meta.keys()))</span>
    <span class="c1">#         raise ValueError(&quot;grid_model must contain &#39;name&#39;&quot;)</span>

    <span class="c1">#     if not isinstance(meta[&quot;name&quot;], str):</span>
    <span class="c1">#         _gmname = meta[&quot;name&quot;]  # shortform</span>
    <span class="c1">#         logger.error(&quot;grid_model: %s&quot;, str(_gmname))</span>
    <span class="c1">#         logger.debug(&quot;grid_model:name was of type %s&quot;, str(type(_gmname)))</span>
    <span class="c1">#         raise ValueError(&quot;grid_model:name must be a string&quot;)</span>

    <span class="c1">#     logger.info(&quot;grid_model section has been processed&quot;)</span>

    <span class="c1">#     return meta</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Processing the fmu:model section.&quot;&quot;&quot;</span>

        <span class="c1"># most of the info from global variables section model:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="c1"># the model section in &quot;template&quot; contains root etc. For revision an</span>
        <span class="c1"># AUTO name may be used to avoid rapid and error-prone naming</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;revision&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">revision</span> <span class="o">==</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">:</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
            <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folders</span><span class="o">.</span><span class="n">parents</span><span class="p">):</span>
                <span class="n">realfoldername</span> <span class="o">=</span> <span class="n">folders</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

                <span class="c1"># match 20.1.xxx style or r003 style</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^[123][0-9]</span><span class="se">\\</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">realfoldername</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
                    <span class="s2">&quot;^[r][0-9][0-9][0-9]&quot;</span><span class="p">,</span> <span class="n">realfoldername</span>
                <span class="p">):</span>
                    <span class="n">rev</span> <span class="o">=</span> <span class="n">realfoldername</span>
                    <span class="k">break</span>

            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;revision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rev</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for fmu:model&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meta</span>

    <span class="k">def</span> <span class="nf">_parse_scratch_folder_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Detect if this is a ERT run and set the relevant instance variables.</span>

<span class="sd">        fmu-dataio will run in different contexts. One of those contexts is when in</span>
<span class="sd">        an FMU run, orchestrated by ERT. To detect if we are in such context:</span>

<span class="sd">        * See if parameters.txt exists on RUNPATH.</span>
<span class="sd">        * Find iter name and realization number from folder names</span>

<span class="sd">        e.g.</span>
<span class="sd">        /scratch/xxx/user/case/realization-11/iter-3</span>

<span class="sd">        The iter folder may have other names, like &quot;pred&quot; which is fully</span>
<span class="sd">        supported. Then iter number (id) shall be 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing folder structure&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_fmurun</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_folderlist</span><span class="p">()</span>

        <span class="n">iterfolder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">casefolder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">userfolder</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folders</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^realization-.&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_fmurun</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">realfolder</span> <span class="o">=</span> <span class="n">folders</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
                <span class="n">iterfolder</span> <span class="o">=</span> <span class="n">folders</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">casefolder</span> <span class="o">=</span> <span class="n">folders</span><span class="p">[</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">userfolder</span> <span class="o">=</span> <span class="n">folders</span><span class="p">[</span><span class="n">num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>

                <span class="n">casepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folders</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num</span><span class="p">]))</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Realization folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">realfolder</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Iter folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">iterfolder</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casefolder</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;User folder is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userfolder</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Root path for case is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casepath</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="o">=</span> <span class="n">casepath</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._casepath has been set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span><span class="p">)</span>

                <span class="c1"># store findings</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_itername</span> <span class="o">=</span> <span class="n">iterfolder</span>  <span class="c1"># name of the folder</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._itername set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itername</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_realname</span> <span class="o">=</span> <span class="n">realfolder</span>  <span class="c1"># name of the folder</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._realname set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realname</span><span class="p">)</span>

                <span class="c1"># also derive the realization_id (realization number) from the folder</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_realization_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_realname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;realization-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>

                <span class="c1"># also derive iteration_id from the folder</span>
                <span class="k">if</span> <span class="s2">&quot;iter-&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">iterfolder</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterfolder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;iter-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iterfolder</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># any custom name of the iteration, like &quot;pred&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not derive iteration ID&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_iterpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">casepath</span> <span class="o">/</span> <span class="n">realfolder</span> <span class="o">/</span> <span class="n">iterfolder</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._iterpath set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterpath</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_realpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">casepath</span> <span class="o">/</span> <span class="n">realfolder</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self._realpath set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realpath</span><span class="p">)</span>

                <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Could not recognize folder structure, assuming non FMU run.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the iteration metadata&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._iteration_id has not been set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._case_uuid has not been set.&quot;</span><span class="p">)</span>

        <span class="n">i_meta</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">uuid_from_string</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_itername</span>
        <span class="n">i_meta</span><span class="p">[</span><span class="s2">&quot;runid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ert</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="s2">&quot;run_id&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for fmu.iteration&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Iteration meta: </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">i_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">i_meta</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_realization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the realization metadata.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._realname has not been set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realization_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._realization_id has not been set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># in future, allowing for realizations without iterations may be needed.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._iteration_id has not been set.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self._case_uuid has not been set.&quot;</span><span class="p">)</span>

        <span class="n">r_meta</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realization_id</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_realname</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">uuid_from_string</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case_uuid</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration_id</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_realization_id</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Note! export of the &quot;jobs&quot; content is paused. This exports a large amount</span>
        <span class="c1"># of data to outgoing metadata, which puts strain on downstream usage. Until</span>
        <span class="c1"># clear use case is present, halt the export.</span>

        <span class="c1"># r_meta[&quot;jobs&quot;] = self._ert[&quot;jobs&quot;]</span>
        <span class="n">r_meta</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ert</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got metadata for fmu:realization&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Realiz. meta: </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">r_meta</span>

    <span class="k">def</span> <span class="nf">_process_meta_fmu_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process fmu.case&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;self._casepath has not been set&quot;</span><span class="p">)</span>

        <span class="n">casemetaroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="o">/</span> <span class="s2">&quot;share&quot;</span> <span class="o">/</span> <span class="s2">&quot;metadata&quot;</span> <span class="o">/</span> <span class="s2">&quot;fmu_case&quot;</span>

        <span class="c1"># may be json or yml</span>
        <span class="n">casemetafile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.yml&quot;</span><span class="p">):</span>
            <span class="n">casemetafile</span> <span class="o">=</span> <span class="n">casemetaroot</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">casemetafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">break</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;casemetafile is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casemetafile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;casemetafile exists: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casemetafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">casemetafile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">casemetafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read existing case metadata from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">casemetafile</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">casemetafile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="n">inmeta</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>  <span class="c1"># will read json also?</span>

            <span class="n">c_meta</span> <span class="o">=</span> <span class="n">inmeta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Case metadata not found, issuing warning&quot;</span><span class="p">)</span>
            <span class="c1"># allow case metadata to be missing but issue a warning; consider this</span>
            <span class="c1"># as a tmp solution as long as fmu-dataio/sumo is under development!</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find the case metadata YAML or JSON file! The run will &quot;</span>
                <span class="s2">&quot;continue, but SUMO upload will not be possible! In future versions, &quot;</span>
                <span class="s2">&quot;a case metadata file will be a requirement! &quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># make a fake case name / uuid</span>
            <span class="n">c_meta</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MISSING!&quot;</span><span class="p">,</span>
                <span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;not-a-valid-uuid&quot;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Case meta: </span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">c_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">c_meta</span>

    <span class="k">def</span> <span class="nf">_get_folderlist</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a list of pure folder names including current PWD up to system root.</span>

<span class="sd">        For example: current is /scratch/xfield/nn/case/realization-33/iter-1</span>
<span class="sd">        shall return [&#39;&#39;, &#39;scratch&#39;, &#39;xfield&#39;, &#39;nn&#39;, &#39;case&#39;, &#39;realization-33&#39;, &#39;iter-1&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="n">current</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">flist</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">flist</span>

    <span class="k">def</span> <span class="nf">_get_meta_strat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get metadata from the stratigraphy block in config; used indirectly.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Config is missing, not possible to parse stratigraphy&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="s2">&quot;stratigraphy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not possible to parse the stratigraphy section&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata4strat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s2">&quot;stratigraphy&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata for stratigraphy is parsed!&quot;</span><span class="p">)</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Public methods</span>
<div class="viewcode-block" id="ExportData.export"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">subfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tagname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Export data objects of &#39;known&#39; type to FMU storage solution with metadata.</span>

<span class="sd">        A &#39;known&#39; type is a type which is known to fmu-dataio. Examples of such known</span>
<span class="sd">        types are XTGeo objects (e.g. a RegularSurface), a Pandas Dataframe, etc.</span>

<span class="sd">        This function will also collect the data spesific class metadata. For &quot;classic&quot;</span>
<span class="sd">        files, the metadata will be stored i a YAML file with same name stem as the</span>
<span class="sd">        data, but with a . in front and &quot;yml&quot; and suffix, e.g.::</span>

<span class="sd">            top_volantis--depth.gri</span>
<span class="sd">            .top_volantis--depth.gri.yml</span>

<span class="sd">        For formats supporting embedded metadata, other solutions may be used.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: XTGeo instance or a Pandas Dataframe instance (more to be supported).</span>
<span class="sd">            subfolder: Optional subfolder below standard level to export to.</span>
<span class="sd">            verbosity: Verbosity level of logging messages. If not spesified,</span>
<span class="sd">                the verbosity level from the instance will be used.</span>
<span class="sd">            name: Override any setting in class initialization. The name of the</span>
<span class="sd">                object. If not set it is tried to be inferred from</span>
<span class="sd">                the xtgeo/pandas/... object. The name is then checked towards the</span>
<span class="sd">                stratigraphy list, and name is replaced with official stratigraphic</span>
<span class="sd">                name if found in static metadata `stratigraphy`. For example, if</span>
<span class="sd">                &quot;TopValysar&quot; is the model name and the actual name</span>
<span class="sd">                is &quot;Valysar Top Fm.&quot; that latter name will be used.</span>
<span class="sd">            unit: Is the unit of the exported item(s), e.g. &quot;m&quot; or &quot;fraction&quot;.</span>
<span class="sd">            tagname: Override any setting in class initialization. This is a short</span>
<span class="sd">                tag description which be be a part of file name.</span>
<span class="sd">            parent: Override any setting in class initialization. This key is</span>
<span class="sd">                required for datatype GridProperty, and refers to the name of the</span>
<span class="sd">                grid geometry.</span>
<span class="sd">            description: Override any setting in class initialization. A multiline</span>
<span class="sd">                description of the data.</span>
<span class="sd">            display_name: Override any setting in class initialization. Set name</span>
<span class="sd">                for clients to use when visualizing. Defaults to name if not given.</span>
<span class="sd">            include_index: For Pandas table output. If True, then the index column will</span>
<span class="sd">                be included. For backward compatibilty, ``index`` also supported.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String: full path to exported item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># backward compatibility</span>
            <span class="n">include_index</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">exporter</span> <span class="o">=</span> <span class="n">_ExportItem</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">obj</span><span class="p">,</span>
            <span class="n">subfolder</span><span class="o">=</span><span class="n">subfolder</span><span class="p">,</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">tagname</span><span class="o">=</span><span class="n">tagname</span><span class="p">,</span>
            <span class="n">display_name</span><span class="o">=</span><span class="n">display_name</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
            <span class="n">include_index</span><span class="o">=</span><span class="n">include_index</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># will return the absolute (resolved) path for exported file</span>
        <span class="k">return</span> <span class="n">exporter</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="ExportData.to_file"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.to_file">[docs]</a>    <span class="nd">@deprecation</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
        <span class="n">deprecated_in</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
        <span class="n">removed_in</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="n">current_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="s2">&quot;Method to_file() is deprecated. Use export() instead&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Deprecated) Use ``export`` function instead.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="c1"># ######################################################################################</span>
<span class="c1"># InitializeCase</span>
<span class="c1"># ######################################################################################</span>


<div class="viewcode-block" id="InitializeCase"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase">[docs]</a><span class="k">class</span> <span class="nc">InitializeCase</span><span class="p">(</span><span class="n">ExportData</span><span class="p">):</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
    <span class="sd">&quot;&quot;&quot;Instantate ExportData object.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: A configuration dictionary. In the standard case this is read</span>
<span class="sd">            from FMU global variables (via fmuconfig). The dictionary must contain</span>
<span class="sd">            some predefined main level keys. If config is None and the env variable</span>
<span class="sd">            FMU_GLOBAL_CONFIG pointing to file is provided, then it will attempt to</span>
<span class="sd">            parse that file.</span>
<span class="sd">        verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">            in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=super-init-not-called</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbosity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_get</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create instance of InitializeCase&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;runfolder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;runfolder&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># define chunks of metadata for primary first order categories</span>
        <span class="c1"># (except class which is set directly later)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4strat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4dollars</span> <span class="o">=</span> <span class="n">DOLLARS</span>  <span class="c1"># schema, version, source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4file</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># file (to be populated in export job)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4tracklog</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># tracklog:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># data:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4display</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># display:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># access:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4masterdata</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># masterdata:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># fmu:</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dryrun&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># strat metadata are used as componenents in some of the other meta keys</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_strat</span><span class="p">()</span>

        <span class="c1"># Get the metadata for some of the general stuff, fully or partly</span>
        <span class="c1"># Note that data are found later (e.g. in _export_item)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_masterdata</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_access</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_tracklog</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_meta_fmu</span><span class="p">()</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Store case data.</span>

    <span class="k">def</span> <span class="nf">_store_case_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">casefolder</span><span class="p">,</span> <span class="n">c_meta</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c_meta</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storing case metadata...&quot;</span><span class="p">)</span>
        <span class="n">case_meta_exists</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">share_caseroot</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">casefolder</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">share_caseroot</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The metadata folder root exists already: &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The metadata folder root is created: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">share_caseroot</span><span class="p">))</span>

        <span class="n">metafile</span> <span class="o">=</span> <span class="n">share_caseroot</span> <span class="o">/</span> <span class="s2">&quot;fmu_case.yml&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case metadata file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>

        <span class="n">existing_metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">metafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Case metadata file already exists. So parsing it.&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                <span class="n">existing_metadata</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">existing_metadata</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reusing fmu.case.uuid&quot;</span><span class="p">)</span>
            <span class="n">fmu_case_uuid</span> <span class="o">=</span> <span class="n">existing_metadata</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">][</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating fresh fmu.case.uuid&quot;</span><span class="p">)</span>
            <span class="n">fmu_case_uuid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;fmu.case.uuid is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fmu_case_uuid</span><span class="p">)</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmu_case_uuid</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4dollars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;case&quot;</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_meta</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4fmu</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="c1"># Should not be possible to initialize a case without</span>
        <span class="c1"># the access.asset field be present.</span>
        <span class="c1"># Outgoing case metadata should contain access.asset only</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;self.metadata4access is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot proceed without access information.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Access information missing.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;asset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;&#39;access&#39; key not found under &#39;asset&#39;&quot;</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;asset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4access</span><span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">]}</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;masterdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata4masterdata</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="n">track</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;created&quot;</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">track</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>

        <span class="c1"># in case the file is deleted but the folder exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Case metafile is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>
            <span class="n">case_meta_exists</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">case_meta_exists</span><span class="p">:</span>
            <span class="c1"># collect needed metadata and save to disk</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create case metadata as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">))</span>
            <span class="n">_utils</span><span class="o">.</span><span class="n">export_metadata_file</span><span class="p">(</span>
                <span class="n">metafile</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span><span class="p">,</span> <span class="n">savefmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_format</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Metadata case file already exists for the case!: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metafile</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">metafile</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_establish_fmu_case_metadata</span><span class="p">(</span>
        <span class="n">casename</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="n">caseuser</span><span class="o">=</span><span class="s2">&quot;nn&quot;</span><span class="p">,</span>
        <span class="n">restart_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Establish the fmu.case card.&quot;&quot;&quot;</span>
        <span class="n">c_meta</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c1"># iterfolder something like /scratch/xxx/user/casename/iter-0</span>

        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casename</span>
        <span class="c1"># uuid is inserted at later stage</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseuser</span>
        <span class="k">if</span> <span class="n">restart_from</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;restart_from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">restart_from</span>
        <span class="n">timeid</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Generated by </span><span class="si">{</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">timeid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">c_meta</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c_meta</span>

<div class="viewcode-block" id="InitializeCase.export"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span>  <span class="c1"># pylint: disable=arguments-differ</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rootfolder</span><span class="o">=</span><span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
        <span class="n">casename</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="n">caseuser</span><span class="o">=</span><span class="s2">&quot;nn&quot;</span><span class="p">,</span>
        <span class="n">restart_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the case metadata to file, e.g. when in an ERT run.</span>

<span class="sd">        This will be the configuration file and output the data necessary to</span>
<span class="sd">        generate a general case ID, typically done as a hook workflow in ERT</span>
<span class="sd">        or similar.</span>

<span class="sd">        Args:</span>
<span class="sd">            rootfolder: The folder root of case, e.g. /scratch/fmu/user/mycase</span>
<span class="sd">            casename: Name of case (run), e.g. &#39;mycase&#39;</span>
<span class="sd">            caseuser: The username fro the case, e.g. the &lt;USER&gt; in ERT</span>
<span class="sd">            restart_from: The uid of iteration from whci to run from</span>
<span class="sd">            description: A free-form description for case</span>

<span class="sd">        This will make an communication point to storage in cloud::</span>

<span class="sd">            case = InitializeCase(config=configdict)</span>
<span class="sd">            case.export(rootfolder=somefolder, caseuser=some_user)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_establish_fmu_case_metadata</span><span class="p">(</span>
            <span class="n">caseuser</span><span class="o">=</span><span class="n">caseuser</span><span class="p">,</span>
            <span class="n">casename</span><span class="o">=</span><span class="n">casename</span><span class="p">,</span>
            <span class="n">restart_from</span><span class="o">=</span><span class="n">restart_from</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">casefolder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">rootfolder</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_folder</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;C_META is:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">c_meta</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;case_folder:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">casefolder</span><span class="p">)</span>

        <span class="c1"># write to file and return the path to stored metadata</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store_case_metadata</span><span class="p">(</span><span class="n">casefolder</span><span class="p">,</span> <span class="n">c_meta</span><span class="p">)</span></div>

<div class="viewcode-block" id="InitializeCase.to_file"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase.to_file">[docs]</a>    <span class="nd">@deprecation</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
        <span class="n">deprecated_in</span><span class="o">=</span><span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
        <span class="n">removed_in</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
        <span class="n">current_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="s2">&quot;Method to_file() is deprecated. Use export() instead&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Deprecated) Use ``export`` function instead.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Equinor 2022 (fmu-dataio release 0.10.3.dev5+ga28cb9f).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>