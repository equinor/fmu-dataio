<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dataio.dataio &mdash; fmu.dataio 0.1.dev1+ga7fcf49 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script>let toggleHintShow = 'Expand';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #C0C0C0" >

          
          
          <a href="../../index.html" class="icon icon-home">
            fmu.dataio
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide and Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preparations.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref/modules.html">API reference for fmu.dataio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datamodel.html">The FMU results data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datastructure.html">Meta export datastructure</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #C0C0C0" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fmu.dataio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dataio.dataio</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dataio.dataio</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for DataIO class.</span>

<span class="sd">The metadata spec is documented as a JSON schema, stored under schema/.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Final</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">PydanticValidationError</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_metadata</span><span class="p">,</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">._definitions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FmuContext</span><span class="p">,</span>
    <span class="n">ValidationError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">._logging</span> <span class="kn">import</span> <span class="n">null_logger</span>
<span class="kn">from</span> <span class="nn">._utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_symlink</span><span class="p">,</span>
    <span class="n">detect_inside_rms</span><span class="p">,</span>  <span class="c1"># dataio_examples,</span>
    <span class="n">export_file_compute_checksum_md5</span><span class="p">,</span>
    <span class="n">export_metadata_file</span><span class="p">,</span>
    <span class="n">prettyprint_dict</span><span class="p">,</span>
    <span class="n">read_metadata_from_file</span><span class="p">,</span>
    <span class="n">some_config_from_env</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.aggregation</span> <span class="kn">import</span> <span class="n">AggregatedData</span>
<span class="kn">from</span> <span class="nn">.case</span> <span class="kn">import</span> <span class="n">InitializeCase</span>
<span class="kn">from</span> <span class="nn">.datastructure._internal.internal</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AllowedContent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.datastructure.configuration</span> <span class="kn">import</span> <span class="n">global_configuration</span>

<span class="c1"># DATAIO_EXAMPLES: Final = dataio_examples()</span>
<span class="n">INSIDE_RMS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">detect_inside_rms</span><span class="p">()</span>


<span class="n">GLOBAL_ENVNAME</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="s2">&quot;FMU_GLOBAL_CONFIG&quot;</span>
<span class="n">SETTINGS_ENVNAME</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;FMU_DATAIO_CONFIG&quot;</span>  <span class="c1"># Feature deprecated, still used for user warning.</span>
<span class="p">)</span>

<span class="n">logger</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">null_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">AggregatedData</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">AggregatedData</span>  <span class="c1"># Backwards compatibility alias</span>
<span class="n">InitializeCase</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">InitializeCase</span>  <span class="c1"># Backwards compatibility alias</span>


<span class="c1"># ======================================================================================</span>
<span class="c1"># Private functions</span>
<span class="c1"># ======================================================================================</span>


<span class="k">def</span> <span class="nf">_validate_variable</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">legals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use data from __annotions__ to validate that overriden var. is of legal type.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">legals</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unsupported key, raise an error&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The input key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is not supported&quot;</span><span class="p">)</span>

    <span class="n">legal_key</span> <span class="o">=</span> <span class="n">legals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="c1"># Potential issue: Eval will use the modules namespace. If given</span>
    <span class="c1">#   &quot;from typing import ClassVar&quot; or similar.</span>
    <span class="c1"># is missing from the namespace, eval(...) will fail.</span>
    <span class="n">valid_type</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">legal_key</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">legal_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">legal_key</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">validcheck</span> <span class="o">=</span> <span class="n">valid_type</span><span class="o">.</span><span class="n">__args__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">validcheck</span> <span class="o">=</span> <span class="n">valid_type</span>

    <span class="k">if</span> <span class="s2">&quot;typing.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">validcheck</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">validcheck</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Wrong type of value, raise an error&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The value of &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is of wrong type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Allowed types are </span><span class="si">{</span><span class="n">validcheck</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip type checking of complex types; &#39;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">validcheck</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># the two next content key related function may require refactoring/simplification</span>
<span class="k">def</span> <span class="nf">_check_content</span><span class="p">(</span><span class="n">proposed</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check content and return a validated version.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evaluate content&quot;</span><span class="p">)</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">proposed</span>
    <span class="n">content_specific</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content is </span><span class="si">%s</span><span class="s2"> of type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">usecontent</span> <span class="o">=</span> <span class="s2">&quot;unset&quot;</span>  <span class="c1"># user warnings on this will in _objectdata_provider</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content is a string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AllowedContent</span><span class="o">.</span><span class="n">requires_additional_input</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;content </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2"> requires additional input&quot;</span><span class="p">)</span>
        <span class="n">usecontent</span> <span class="o">=</span> <span class="n">content</span>
        <span class="n">content_specific</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not relevant when content is a string</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;usecontent is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecontent</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content is a dictionary&quot;</span><span class="p">)</span>
        <span class="n">usecontent</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;usecontent is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecontent</span><span class="p">)</span>
        <span class="n">content_specific</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">usecontent</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content_specific is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">content_specific</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content_specific</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Content is incorrectly formatted. When giving content as a dict, &quot;</span>
                <span class="s2">&quot;it must be formatted as:&quot;</span>
                <span class="s2">&quot;{&#39;mycontent&#39;: {extra_key: extra_value} where mycontent is a string &quot;</span>
                <span class="s2">&quot;and in the list of valid contents, and extra keys in associated &quot;</span>
                <span class="s2">&quot; dictionary must be valid keys for this content.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;The &#39;content&#39; must be string or dict&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">usecontent</span> <span class="o">!=</span> <span class="s2">&quot;unset&quot;</span> <span class="ow">and</span> <span class="n">usecontent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AllowedContent</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid content: &lt;</span><span class="si">{</span><span class="n">usecontent</span><span class="si">}</span><span class="s2">&gt;! &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Valid content: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AllowedContent</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;outgoing content is set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecontent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content_specific</span><span class="p">:</span>
        <span class="n">content_specific</span> <span class="o">=</span> <span class="n">_content_validate</span><span class="p">(</span><span class="n">usecontent</span><span class="p">,</span> <span class="n">content_specific</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content has no extra information&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">usecontent</span><span class="p">,</span> <span class="n">content_specific</span>


<span class="k">def</span> <span class="nf">_content_validate</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AllowedContent</span><span class="o">.</span><span class="n">model_validate</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">fields</span><span class="p">})</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span>
            <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">PydanticValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The field </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> has one or more errors that makes it</span>
<span class="s2">impossible to create valid content. The data will still be exported but no</span>
<span class="s2">metadata will be made. You are strongly encouraged to correct your</span>
<span class="s2">configuration. Invalid configuration may be disallowed in future versions.</span>

<span class="s2">Detailed information:</span>
<span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span>


<span class="c1"># ======================================================================================</span>
<span class="c1"># Public function to read/load assosiated metadata given a file (e.g. a map file)</span>
<span class="c1"># ======================================================================================</span>


<div class="viewcode-block" id="read_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.read_metadata">[docs]</a><span class="k">def</span> <span class="nf">read_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the metadata as a dictionary given a filename.</span>

<span class="sd">    If the filename is e.g. /some/path/mymap.gri, the assosiated metafile</span>
<span class="sd">    will be /some/path/.mymap.gri.yml (or json?)</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: The full path filename to the data-object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with metadata read from the assiated metadata file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">read_metadata_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<span class="c1"># ======================================================================================</span>
<span class="c1"># ExportData, public class</span>
<span class="c1"># ======================================================================================</span>


<div class="viewcode-block" id="ExportData"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExportData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for exporting data with rich metadata in FMU.</span>

<span class="sd">    This class sets up the general metadata content to be applied in export. The idea is</span>
<span class="sd">    that one ExportData instance can be re-used for several similar export() jobs. For</span>
<span class="sd">    example::</span>

<span class="sd">        edata = dataio.ExportData(</span>
<span class="sd">            config=CFG, content=&quot;depth&quot;, unit=&quot;m&quot;, vertical_domain={&quot;depth&quot;: &quot;msl&quot;},</span>
<span class="sd">            timedata=None, is_prediction=True, is_observation=False,</span>
<span class="sd">            tagname=&quot;faultlines&quot;, workflow=&quot;rms structural model&quot;,</span>
<span class="sd">        )</span>

<span class="sd">        for name in [&quot;TopOne&quot;, TopTwo&quot;, &quot;TopThree&quot;]:</span>
<span class="sd">            poly = xtgeo.polygons_from_roxar(PRJ, hname, POL_FOLDER)</span>

<span class="sd">            out = ed.export(poly, name=name)</span>

<span class="sd">    Almost all keyword settings like ``name``, ``tagname`` etc can be set in both the</span>
<span class="sd">    ExportData instance and directly in the ``generate_metadata`` or ``export()``</span>
<span class="sd">    function, to provide flexibility for different use cases. If both are set, the</span>
<span class="sd">    ``export()`` setting will win followed by ``generate_metadata() and finally</span>
<span class="sd">    ExportData()``.</span>

<span class="sd">    A note on &#39;pwd&#39; and &#39;rootpath&#39; and &#39;casepath&#39;: The &#39;pwd&#39; is the process working</span>
<span class="sd">    directory, which is folder where the process (script) starts. The &#39;rootpath&#39; is the</span>
<span class="sd">    folder from which relative file names are relative to and is normally auto-detected.</span>
<span class="sd">    The user can however force set the &#39;actual&#39; rootpath by providing the input</span>
<span class="sd">    `casepath`. In case of running a RMS project interactive on disk::</span>

<span class="sd">        /project/foo/resmod/ff/2022.1.0/rms/model                   &lt;&lt; pwd</span>
<span class="sd">        /project/foo/resmod/ff/2022.1.0/                            &lt;&lt; rootpath</span>

<span class="sd">        A file:</span>

<span class="sd">        /project/foo/resmod/ff/2022.1.0/share/results/maps/xx.gri   &lt;&lt; example absolute</span>
<span class="sd">                                        share/results/maps/xx.gri   &lt;&lt; example relative</span>

<span class="sd">    When running an ERT forward job using a normal ERT job (e.g. a script)::</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2                      &lt;&lt; pwd</span>
<span class="sd">        /scratch/nn/case                                            &lt;&lt; rootpath</span>

<span class="sd">        A file:</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; absolute</span>
<span class="sd">                         realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; relative</span>

<span class="sd">    When running an ERT forward job but here executed from RMS::</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2/rms/model            &lt;&lt; pwd</span>
<span class="sd">        /scratch/nn/case                                            &lt;&lt; rootpath</span>

<span class="sd">        A file:</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; absolute</span>
<span class="sd">                         realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; relative</span>


<span class="sd">    Args:</span>
<span class="sd">        access_ssdl: Optional. A dictionary that will overwrite or append</span>
<span class="sd">            to the default ssdl settings read from the config. Example:</span>
<span class="sd">            ``{&quot;access_level&quot;: &quot;restricted&quot;, &quot;rep_include&quot;: False}``</span>

<span class="sd">        casepath: To override the automatic and actual ``rootpath``. Absolute path to</span>
<span class="sd">            the case root. If not provided, the rootpath will be attempted parsed from</span>
<span class="sd">            the file structure or by other means. See also fmu_context, where &quot;case&quot;</span>
<span class="sd">            may need an explicit casepath!</span>

<span class="sd">        config: Required in order to produce valid metadata, either as key (here) or</span>
<span class="sd">            through an environment variable. A dictionary with static settings.</span>
<span class="sd">            In the standard case this is read from FMU global variables</span>
<span class="sd">            (via fmuconfig). The dictionary must contain some</span>
<span class="sd">            predefined main level keys to work with fmu-dataio. If the key is missing or</span>
<span class="sd">            key value is None, then it will look for the environment variable</span>
<span class="sd">            FMU_GLOBAL_CONFIG to detect the file. If no success in finding the file, a</span>
<span class="sd">            UserWarning is made. If both a valid config is provided and</span>
<span class="sd">            FMU_GLOBAL_CONFIG is provided in addition, the latter will be used.</span>
<span class="sd">            Note that this key shall be set while initializing the instance, ie. it</span>
<span class="sd">            cannot be used in ``generate_metadata()`` or ``export()``.</span>
<span class="sd">            Note also: If missing or empty, export() may still be done, but without a</span>
<span class="sd">            metadata file (this feature may change in future releases).</span>

<span class="sd">        content: Optional, default is &quot;depth&quot;. Is a string or a dictionary with one key.</span>
<span class="sd">            Example is &quot;depth&quot; or {&quot;fluid_contact&quot;: {&quot;xxx&quot;: &quot;yyy&quot;, &quot;zzz&quot;: &quot;uuu&quot;}}.</span>
<span class="sd">            Content is checked agains a white-list for validation!</span>

<span class="sd">        fmu_context: In normal forward models, the fmu_context is ``realization`` which</span>
<span class="sd">            is default and will put data per realization. Other contexts may be ``case``</span>
<span class="sd">            which will put data relative to the case root (see also casepath). Another</span>
<span class="sd">            important context is &quot;preprocessed&quot; which will output to a dedicated</span>
<span class="sd">            &quot;preprocessed&quot; folder instead, and metadata will be partially re-used in</span>
<span class="sd">            an ERT model run. If a non-FMU run is detected (e.g. you run from project),</span>
<span class="sd">            fmu-dataio will detect that and set actual context to None as fall-back</span>
<span class="sd">            (unless preprocessed is specified). If value is &quot;preprocessed&quot;, see also</span>
<span class="sd">            ``reuse_metadata`` key.</span>

<span class="sd">        description: A multiline description of the data either as a string or a list</span>
<span class="sd">            of strings.</span>

<span class="sd">        display_name: Optional, set name for clients to use when visualizing.</span>

<span class="sd">        forcefolder: This setting shall only be used as exception, and will make it</span>
<span class="sd">            possible to output to a non-standard folder. A ``/`` in front will indicate</span>
<span class="sd">            an absolute path*; otherwise it will be relative to casepath or rootpath, as</span>
<span class="sd">            dependent on the both fmu_context and the is_observations boolean value. A</span>
<span class="sd">            typical use-case is forcefolder=&quot;seismic&quot; which will replace the &quot;cubes&quot;</span>
<span class="sd">            standard folder for Cube output with &quot;seismics&quot;. Use with care and avoid if</span>
<span class="sd">            possible! (*) For absolute paths, the class variable</span>
<span class="sd">            allow_forcefolder_absolute must set to True.</span>

<span class="sd">        grid_model: Currently allowed but planned for deprecation</span>

<span class="sd">        include_index: This applies to Pandas (table) data only, and if True then the</span>
<span class="sd">            index column will be exported. Deprecated, use class variable</span>
<span class="sd">            ``table_include_index`` instead</span>

<span class="sd">        is_prediction: True (default) if model prediction data</span>

<span class="sd">        is_observation: Default is False. If True, then disk storage will be on the</span>
<span class="sd">            &quot;share/observations&quot; folder, otherwise on share/result. An exception arise</span>
<span class="sd">            if fmu_context is &quot;preprocessed&quot;, then the folder will be set to</span>
<span class="sd">            &quot;share/processed&quot; irrespective the value of is_observation.</span>

<span class="sd">        name: Optional but recommended. The name of the object. If not set it is tried</span>
<span class="sd">            to be inferred from the xtgeo/pandas/... object. The name is then checked</span>
<span class="sd">            towards the stratigraphy list, and name is replaced with official</span>
<span class="sd">            stratigraphic name if found in static metadata `stratigraphy`. For example,</span>
<span class="sd">            if &quot;TopValysar&quot; is the model name and the actual name is &quot;Valysar Top Fm.&quot;</span>
<span class="sd">            that latter name will be used.</span>

<span class="sd">        parent: Optional. This key is required for datatype GridProperty, and</span>
<span class="sd">            refers to the name of the grid geometry.</span>

<span class="sd">        realization: Optional, default is -999 which means that realization shall be</span>
<span class="sd">            detected automatically from the FMU run. Can be used to override in rare</span>
<span class="sd">            cases. If so, numbers must be &gt;= 0</span>

<span class="sd">        reuse_metadata_rule: This input is None or a string describing rule for reusing</span>
<span class="sd">            metadata. Default is None, but if the input is a file string or object with</span>
<span class="sd">            already valid metadata, then it is assumed to be &quot;preprocessed&quot;, which</span>
<span class="sd">            merges the metadata after predefined rules.</span>

<span class="sd">        runpath: TODO! Optional and deprecated. The relative location of the current run</span>
<span class="sd">            root. Optional and will in most cases be auto-detected, assuming that FMU</span>
<span class="sd">            folder conventions are followed. For an ERT run e.g.</span>
<span class="sd">            /scratch/xx/nn/case/realization-0/iter-0/. while in a revision at project</span>
<span class="sd">            disc it will the revision root e.g. /project/xx/resmod/ff/21.1.0/.</span>

<span class="sd">        subfolder: It is possible to set one level of subfolders for file output.</span>
<span class="sd">            The input should only accept a single folder name, i.e. no paths. If paths</span>
<span class="sd">            are present, a deprecation warning will be raised.</span>

<span class="sd">        tagname: This is a short tag description which be be a part of file name.</span>

<span class="sd">        timedata: If given, a list of lists with dates, .e.g.</span>
<span class="sd">            [[20200101, &quot;monitor&quot;], [20180101, &quot;base&quot;]] or just [[2021010]]. The output</span>
<span class="sd">            to metadata will from version 0.9 be different (API change)</span>

<span class="sd">        vertical_domain: This is dictionary with a key and a reference e.g.</span>
<span class="sd">            {&quot;depth&quot;: &quot;msl&quot;} which is default if missing.</span>

<span class="sd">        workflow: Short tag desciption of workflow (as description)</span>

<span class="sd">        undef_is_zero: Flags that nans should be considered as zero in aggregations</span>


<span class="sd">    .. note:: Comment on time formats</span>

<span class="sd">        If two dates are present (i.e. the element represents a difference, the input</span>
<span class="sd">        time format is on the form::</span>

<span class="sd">            timedata: [[20200101, &quot;monitor&quot;], [20180101, &quot;base&quot;]]</span>

<span class="sd">        Hence the last data (monitor) usually comes first.</span>

<span class="sd">        In the new version this will shown in metadata files as where the oldest date is</span>
<span class="sd">        shown as t0::</span>

<span class="sd">            data:</span>
<span class="sd">              t0:</span>
<span class="sd">                value: 2018010T00:00:00</span>
<span class="sd">                description: base</span>
<span class="sd">              t1:</span>
<span class="sd">                value: 202020101T00:00:00</span>
<span class="sd">                description: monitor</span>

<span class="sd">        The output files will be on the form: somename--t1_t0.ext</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># This role for this class is to be:</span>
    <span class="c1"># - public (end user) interface</span>
    <span class="c1"># - collect the full settings from global config, user keys and class variables</span>
    <span class="c1"># - process and validate these settings</span>
    <span class="c1"># - establish PWD and rootpath</span>
    <span class="c1">#</span>
    <span class="c1"># Then other classes will further do the detailed metadata processing, cf _MetaData</span>
    <span class="c1"># and subsequent classes called by _MetaData</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>

    <span class="c1"># class variables</span>
    <span class="n">allow_forcefolder_absolute</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">arrow_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;arrow&quot;</span>
    <span class="n">case_folder</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;share/metadata&quot;</span>
    <span class="n">createfolder</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">cube_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;segy&quot;</span>
    <span class="n">filename_timedata_reverse</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># reverse order output file name</span>
    <span class="n">grid_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;roff&quot;</span>
    <span class="n">include_ertjobs</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># if True, include jobs.json from ERT</span>
    <span class="n">legacy_time_format</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">meta_format</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span>
    <span class="n">polygons_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>  <span class="c1"># or use &quot;csv|xtgeo&quot;</span>
    <span class="n">points_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>  <span class="c1"># or use &quot;csv|xtgeo&quot;</span>
    <span class="n">surface_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;irap_binary&quot;</span>
    <span class="n">table_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="n">dict_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
    <span class="n">table_include_index</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">verifyfolder</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_inside_rms</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># developer only! if True pretend inside RMS</span>

    <span class="c1"># input keys (alphabetic)</span>
    <span class="n">access_ssdl</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aggregation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">casepath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">depth_reference</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;msl&quot;</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fmu_context</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">FmuContext</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">FmuContext</span><span class="o">.</span><span class="n">REALIZATION</span>
    <span class="p">)</span>  <span class="c1"># post init converts to FmuContext</span>
    <span class="n">forcefolder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">grid_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_observation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_prediction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">undef_is_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">realization</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">reuse_metadata_rule</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">runpath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">subfolder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">tagname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">timedata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">verbosity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DEPRECATED&quot;</span>  <span class="c1"># remove in version 2</span>
    <span class="n">vertical_domain</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">table_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># some keys that are modified version of input, prepended with _use</span>
    <span class="n">_usecontent</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_usefmtflag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># storing resulting state variables for instance, non-public:</span>
    <span class="n">_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_pwd</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_config_is_valid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># &lt;&lt; NB! storing ACTUAL casepath:</span>
    <span class="n">_rootpath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">!=</span> <span class="s2">&quot;DEPRECATED&quot;</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Using the &#39;verbosity&#39; key is now deprecated and will have no &quot;</span>
                <span class="s2">&quot;effect and will be removed in near future. Please remove it from the &quot;</span>
                <span class="s2">&quot;argument list. Set logging level from client script in the standard &quot;</span>
                <span class="s2">&quot;manner instead.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running __post_init__ ExportData&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Global config is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prettyprint_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span> <span class="o">=</span> <span class="n">FmuContext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>

        <span class="c1"># set defaults for mutable keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_domain</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;msl&quot;</span><span class="p">}</span>

        <span class="c1"># if input is provided as an ENV variable pointing to a YAML file; will override</span>
        <span class="k">if</span> <span class="n">SETTINGS_ENVNAME</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Providing input settings through environment variables is deprecated, &quot;</span>
                <span class="s2">&quot;use ExportData(**yaml_load(&lt;your_file&gt;)) instead. To &quot;</span>
                <span class="s2">&quot;disable this warning, remove the &#39;FMU_DATAIO_CONFIG&#39; env.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># global config which may be given as env variable -&gt; a file; will override</span>
        <span class="k">if</span> <span class="n">GLOBAL_ENVNAME</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">some_config_from_env</span><span class="p">(</span><span class="n">GLOBAL_ENVNAME</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_content_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_globalconfig_from_settings</span><span class="p">()</span>

        <span class="c1"># check state of global config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span> <span class="o">=</span> <span class="n">global_configuration</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span><span class="p">:</span>
            <span class="c1"># TODO: This needs refinement: _config_is_valid should be removed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">global_configuration</span><span class="o">.</span><span class="n">roundtrip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_establish_pwd_rootpath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_deprecations_or_notimplemented</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FMU context is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ran __post_init__&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_show_deprecations_or_notimplemented</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Warn on deprecated keys or on stuff not implemented yet.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;runpath&#39; key has currently no function. It will be evaluated for &quot;</span>
                <span class="s2">&quot;removal in fmu-dataio version 2. Use &#39;casepath&#39; instead!&quot;</span><span class="p">,</span>
                <span class="ne">PendingDeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_model</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;grid_model&#39; key has currently no function. It will be evaluated &quot;</span>
                <span class="s2">&quot;for removal in fmu-dataio version 2.&quot;</span><span class="p">,</span>
                <span class="ne">PendingDeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_content_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the given &#39;content&#39; input.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_usecontent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_specific</span> <span class="o">=</span> <span class="n">_check_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_fmucontext_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the given &#39;fmu_context&#39; input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span> <span class="o">=</span> <span class="n">FmuContext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_fmt_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># treat special handling of &quot;xtgeo&quot; in format name:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_fformat</span> <span class="o">==</span> <span class="s2">&quot;csv|xtgeo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons_fformat</span> <span class="o">==</span> <span class="s2">&quot;csv|xtgeo&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_usefmtflag</span> <span class="o">=</span> <span class="s2">&quot;xtgeo&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using flag format: &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usefmtflag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_check_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update instance settings (properties) from other routines.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Try new settings </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">)</span>

        <span class="c1"># derive legal input from dataclass signature</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">legals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">annots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>
        <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">in</span> <span class="n">legals</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">legals</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>  <span class="c1"># config cannot be updated</span>

        <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">in</span> <span class="n">newsettings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot have &#39;config&#39; outside instance initialization&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">newsettings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_validate_variable</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">legals</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New setting OK for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_show_deprecations_or_notimplemented</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_content_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fmucontext_key</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validate FMU context which is now </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_globalconfig_from_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A few user settings may update/append the global config directly.&quot;&quot;&quot;</span>
        <span class="n">newglobals</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_ssdl</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ssdl&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]:</span>
                <span class="n">newglobals</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">][</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">newglobals</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">][</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_ssdl</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Updated global config&#39;s access.ssdl value: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newglobals</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">newglobals</span>

    <span class="k">def</span> <span class="nf">_establish_pwd_rootpath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish state variables pwd and the (initial) rootpath.</span>

<span class="sd">        The self._pwd stores the process working directory, i.e. the folder</span>
<span class="sd">        from which the process is ran</span>

<span class="sd">        The self._rootpath stores the folder from which is the base root for all</span>
<span class="sd">        relative output files. This rootpath may be dependent on if this is a FMU run</span>
<span class="sd">        or just an interactive run.</span>

<span class="sd">        Hence this &#39;initial&#39; rootpath can be updated later!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Establish pwd and actual casepath, inside RMS flag is </span><span class="si">%s</span><span class="s2"> (actual: </span><span class="si">%s</span><span class="s2">))&quot;</span><span class="p">,</span>
            <span class="n">ExportData</span><span class="o">.</span><span class="n">_inside_rms</span><span class="p">,</span>
            <span class="n">INSIDE_RMS</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># fmu_context 1: Running RMS, we are in conventionally in rootpath/rms/model</span>
        <span class="c1"># fmu_context 2: ERT FORWARD_JOB, at case = rootpath=RUNPATH/../../. level</span>
        <span class="c1"># fmu_context 3: ERT WORKFLOW_JOB, running somewhere/anywhere else</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">casepath</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casepath</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casepath</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The casepath is hard set as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ExportData</span><span class="o">.</span><span class="n">_inside_rms</span> <span class="ow">or</span> <span class="n">INSIDE_RMS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Run from inside RMS: ExportData._inside_rms=</span><span class="si">%s</span><span class="s2">, INSIDE_RMS=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">ExportData</span><span class="o">.</span><span class="n">_inside_rms</span><span class="p">,</span>
                    <span class="n">INSIDE_RMS</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">/</span> <span class="s2">&quot;../../.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="n">ExportData</span><span class="o">.</span><span class="n">_inside_rms</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pwd:        </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rootpath:   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_obj_if_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Inferrable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">Inferrable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;When obj is file-like, it must be checked + assume preprocessed.</span>

<span class="sd">        In addition, if preprocessed, derive the name, tagname, subfolder if present and</span>
<span class="sd">        those are not set already.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_metadata_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuse_metadata_rule</span> <span class="o">=</span> <span class="s2">&quot;preprocessed&quot;</span>

            <span class="n">currentmeta</span> <span class="o">=</span> <span class="n">read_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;_preprocessed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">currentmeta</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The special entry for preprocessed data &lt;_preprocessed&gt; is&quot;</span>
                    <span class="s2">&quot;missing in the metadata. A possible solution is to rerun the&quot;</span>
                    <span class="s2">&quot;preprocessed export.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span> <span class="ow">and</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tagname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span> <span class="o">=</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">][</span><span class="s2">&quot;tagname&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfolder</span> <span class="ow">and</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subfolder&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subfolder</span> <span class="o">=</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">][</span><span class="s2">&quot;subfolder&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Public methods:</span>
    <span class="c1"># ==================================================================================</span>

<div class="viewcode-block" id="ExportData.generate_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.generate_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">generate_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Inferrable</span><span class="p">,</span>
        <span class="n">compute_md5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and return the complete metadata for a provided object.</span>

<span class="sd">        An object may be a map, 3D grid, cube, table, etc which is of a known and</span>
<span class="sd">        supported type.</span>

<span class="sd">        Examples of such known types are XTGeo objects (e.g. a RegularSurface),</span>
<span class="sd">        a Pandas Dataframe, a PyArrow table, etc.</span>

<span class="sd">        If the key ``reuse_metadata_rule`` is applied with legal value, the object may</span>
<span class="sd">        also be a reference to a file with existing metadata which then will be re-used.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: XTGeo instance, a Pandas Dataframe instance or other supported object.</span>
<span class="sd">            compute_md5: If True, compute a MD5 checksum for the exported file.</span>
<span class="sd">            **kwargs: For other arguments, see ExportData() input keys. If they</span>
<span class="sd">                exist both places, this function will override!</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with all metadata.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the ``compute_md5`` key is False, the ``file.checksum_md5`` will be</span>
<span class="sd">            empty. If true, the MD5 checksum will be generated based on export to</span>
<span class="sd">            a temporary file, which may be time-consuming if the file is large.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generate metadata...&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;KW args </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_settings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_globalconfig_from_settings</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span> <span class="o">=</span> <span class="n">global_configuration</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span><span class="p">:</span>
            <span class="c1"># TODO: This needs refinement: _config_is_valid should be removed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">global_configuration</span><span class="o">.</span><span class="n">roundtrip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_obj_if_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_establish_pwd_rootpath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_content_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_fmt_flag</span><span class="p">()</span>

        <span class="n">metaobj</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="n">compute_md5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metaobj</span><span class="o">.</span><span class="n">generate_export_metadata</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metaobj</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The metadata are now ready!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExportData.export"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Inferrable</span><span class="p">,</span>
        <span class="n">return_symlink</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export data objects of &#39;known&#39; type to FMU storage solution with metadata.</span>

<span class="sd">        This function will also collect the data spesific class metadata. For &quot;classic&quot;</span>
<span class="sd">        files, the metadata will be stored i a YAML file with same name stem as the</span>
<span class="sd">        data, but with a . in front and &quot;yml&quot; and suffix, e.g.::</span>

<span class="sd">            top_volantis--depth.gri</span>
<span class="sd">            .top_volantis--depth.gri.yml</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: XTGeo instance, a Pandas Dataframe instance or other supported object.</span>
<span class="sd">            return_symlink: If fmu_context is &#39;case_symlink_realization&#39; then the link</span>
<span class="sd">                adress will be returned if this is True; otherwise the physical file</span>
<span class="sd">                path will be returned.</span>
<span class="sd">            **kwargs: For other arguments, see ExportData() input keys. If they</span>
<span class="sd">                exist both places, this function will override!</span>

<span class="sd">        Returns:</span>
<span class="sd">            String: full path to exported item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table_index&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">])</span>
        <span class="n">metafile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span><span class="p">)</span>

        <span class="n">useflag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_include_index</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usefmtflag</span>
        <span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_obj_if_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Export to file and compute MD5 sum, using flag: &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="n">useflag</span><span class="p">)</span>
        <span class="c1"># inject md5 checksum in metadata</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;checksum_md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_file_compute_checksum_md5</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span>
            <span class="n">outfile</span><span class="p">,</span>
            <span class="n">flag</span><span class="o">=</span><span class="n">useflag</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># BUG(?): Looks buggy, if flag is bool export_file will blow up.</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual file is:   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span><span class="p">:</span>
            <span class="n">export_metadata_file</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">savefmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_format</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata file is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metafile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Data will be exported, but without metadata.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

        <span class="c1"># generate symlink if requested</span>
        <span class="n">outfile_target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;absolute_path_symlink&quot;</span><span class="p">):</span>
            <span class="n">outfile_target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path_symlink&quot;</span><span class="p">])</span>
            <span class="n">outfile_source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">])</span>
            <span class="n">create_symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outfile_source</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile_target</span><span class="p">))</span>
            <span class="n">metafile_target</span> <span class="o">=</span> <span class="n">outfile_target</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span><span class="p">)</span>
            <span class="n">create_symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile_target</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">if</span> <span class="n">return_symlink</span> <span class="ow">and</span> <span class="n">outfile_target</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile_target</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Equinor 2024 (fmu-dataio release 0.1.dev1+ga7fcf49).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>