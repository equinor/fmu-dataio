<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dataio.dataio &mdash; fmu.dataio 0.1.dev1+g2c13a20 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script>let toggleHintShow = 'Expand';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #C0C0C0" >

          
          
          <a href="../../index.html" class="icon icon-home">
            fmu.dataio
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#getting-started">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preparations.html">Prepare FMU workflow to produce rich metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiref/modules.html">API reference for fmu.dataio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../datamodel.html">The FMU results data model</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #C0C0C0" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fmu.dataio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dataio.dataio</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dataio.dataio</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module for DataIO class.</span>

<span class="sd">The metadata spec is documented as a JSON schema, stored under schema/.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Final</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_metadata</span>
<span class="kn">from</span> <span class="nn">._definitions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ALLOWED_CONTENTS</span><span class="p">,</span>
    <span class="n">ALLOWED_FMU_CONTEXTS</span><span class="p">,</span>
    <span class="n">CONTENTS_REQUIRED</span><span class="p">,</span>
    <span class="n">DEPRECATED_CONTENTS</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">._utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_symlink</span><span class="p">,</span>
    <span class="n">detect_inside_rms</span><span class="p">,</span>
    <span class="n">drop_nones</span><span class="p">,</span>
    <span class="n">export_file_compute_checksum_md5</span><span class="p">,</span>
    <span class="n">export_metadata_file</span><span class="p">,</span>
    <span class="n">filter_validate_metadata</span><span class="p">,</span>
    <span class="n">generate_description</span><span class="p">,</span>
    <span class="n">prettyprint_dict</span><span class="p">,</span>
    <span class="n">read_metadata</span> <span class="k">as</span> <span class="n">_utils_read_metadata</span><span class="p">,</span>
    <span class="n">some_config_from_env</span><span class="p">,</span>
    <span class="n">uuid_from_string</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">INSIDE_RMS</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">detect_inside_rms</span><span class="p">()</span>


<span class="n">GLOBAL_ENVNAME</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="s2">&quot;FMU_GLOBAL_CONFIG&quot;</span>
<span class="n">SETTINGS_ENVNAME</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="s2">&quot;FMU_DATAIO_CONFIG&quot;</span>  <span class="c1"># input settings from a spesific file!</span>

<span class="n">logger</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="ValidationError"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ValidationError">[docs]</a><span class="k">class</span> <span class="nc">ValidationError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raise error while validating.&quot;&quot;&quot;</span></div>


<span class="c1"># ======================================================================================</span>
<span class="c1"># Private functions</span>
<span class="c1"># ======================================================================================</span>


<span class="k">def</span> <span class="nf">_validate_variable</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">legals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">type</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use data from __annotions__ to validate that overriden var. is of legal type.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">legals</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unsupported key, raise an error&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The input key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is not supported&quot;</span><span class="p">)</span>

    <span class="n">legal_key</span> <span class="o">=</span> <span class="n">legals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="c1"># Potential issue: Eval will use the modules namespace. If given</span>
    <span class="c1">#   &quot;from typing import ClassVar&quot; or similar.</span>
    <span class="c1"># is missing from the namespace, eval(...) will fail.</span>
    <span class="n">valid_type</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">legal_key</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">legal_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">legal_key</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">validcheck</span> <span class="o">=</span> <span class="n">valid_type</span><span class="o">.</span><span class="n">__args__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">validcheck</span> <span class="o">=</span> <span class="n">valid_type</span>

    <span class="k">if</span> <span class="s2">&quot;typing.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">validcheck</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">validcheck</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Wrong type of value, raise an error&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The value of &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is of wrong type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Allowed types are </span><span class="si">{</span><span class="n">validcheck</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skip type checking of complex types; &#39;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">validcheck</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_check_global_config</span><span class="p">(</span>
    <span class="n">globalconfig</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A minimum check/validation of the static global_config.</span>

<span class="sd">    Currently far from a full validation. For now, just check that some required</span>
<span class="sd">    keys are present in the config and warn/raise if not.</span>

<span class="sd">    PS! Seems like a good job for jsonschema, but the produced error message are not</span>
<span class="sd">    informative enough to provide meaningful information to user when something is</span>
<span class="sd">    wrong.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">globalconfig</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Empty global config, expect input from environment_variable instead&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">missing_keys</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># check required key presence</span>
    <span class="n">config_required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">,</span> <span class="s2">&quot;masterdata&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">required_key</span> <span class="ow">in</span> <span class="n">config_required_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">required_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">globalconfig</span><span class="p">:</span>
            <span class="n">missing_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;One or more keys required for valid metadata are not found: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2"> (perhaps the config is empty?) &quot;</span>
        <span class="p">)</span>

    <span class="c1"># check &quot;stratigraphy&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;stratigraphy&quot;</span> <span class="ow">in</span> <span class="n">globalconfig</span><span class="p">:</span>
        <span class="c1"># we currently allow (why?) stratigraphy key missing from config.</span>
        <span class="n">strat</span> <span class="o">=</span> <span class="n">globalconfig</span><span class="p">[</span><span class="s2">&quot;stratigraphy&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">strat</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;The &#39;stratigraphy&#39; must be a dictionary.</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># Loop the entries in &#39;stratigraphy&#39;</span>
        <span class="c1"># These keys are custom, but we want error messages to point to the key when</span>
        <span class="c1"># issues are discovered. This makes it tricky to use jsonschema. Pydantic might</span>
        <span class="c1"># be an option. But for now, just go through all items and do defined checks.</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">strat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;name&#39; is missing. </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;name&#39; must be a string.</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="s2">&quot;stratigraphic&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;stratigraphic&#39; is missing.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stratigraphic&quot;</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;stratigraphic&#39; must be a boolean.</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="s2">&quot;alias&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;alias&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;alias&#39; must be a list.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;alias&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;alias&#39; items must be strings</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                    <span class="c1"># After checking and warning, remove empty entries</span>
                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;alias&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;alias&quot;</span><span class="p">]))</span>

            <span class="k">if</span> <span class="s2">&quot;stratigraphic_alias&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stratigraphic_alias&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;stratigraphic_alias&#39; must be list.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stratigraphic_alias&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stratigraphy.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: &#39;stratigraphic_alias&#39; items &quot;</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;must be strings.</span><span class="se">\n</span><span class="s2">&quot;</span>

                    <span class="c1"># After checking and warning, remove empty entries</span>
                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stratigraphic_alias&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stratigraphic_alias&quot;</span><span class="p">])</span>
                    <span class="p">)</span>

    <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;err&quot;</span> <span class="ow">in</span> <span class="n">action</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;The metadata may become invalid; hence no metadata file will be made, &quot;</span>
            <span class="s2">&quot;but the data item may still be exported. Note: allowing these keys to &quot;</span>
            <span class="s2">&quot;be missing is a temporary solution that may change in future versions!&quot;</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="ne">PendingDeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="c1"># the two next content key related function may require refactoring/simplification</span>
<span class="k">def</span> <span class="nf">_check_content</span><span class="p">(</span><span class="n">proposed</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check content and return a validated version.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evaluate content&quot;</span><span class="p">)</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">proposed</span>
    <span class="n">content_specific</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content is </span><span class="si">%s</span><span class="s2"> of type </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">usecontent</span> <span class="o">=</span> <span class="s2">&quot;unset&quot;</span>  <span class="c1"># user warnings on this will in _objectdata_provider</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content is a string&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">CONTENTS_REQUIRED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;content </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2"> requires additional input&quot;</span><span class="p">)</span>
        <span class="n">usecontent</span> <span class="o">=</span> <span class="n">content</span>
        <span class="n">content_specific</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># not relevant when content is a string</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;usecontent is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecontent</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content is a dictionary&quot;</span><span class="p">)</span>
        <span class="n">usecontent</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">keys</span><span class="p">()))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;usecontent is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecontent</span><span class="p">)</span>
        <span class="n">content_specific</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">usecontent</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content_specific is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">content_specific</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content_specific</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Content is incorrectly formatted. When giving content as a dict, &quot;</span>
                <span class="s2">&quot;it must be formatted as:&quot;</span>
                <span class="s2">&quot;{&#39;mycontent&#39;: {extra_key: extra_value} where mycontent is a string &quot;</span>
                <span class="s2">&quot;and in the list of valid contents, and extra keys in associated &quot;</span>
                <span class="s2">&quot; dictionary must be valid keys for this content.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;The &#39;content&#39; must be string or dict&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">usecontent</span> <span class="o">!=</span> <span class="s2">&quot;unset&quot;</span> <span class="ow">and</span> <span class="n">usecontent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_CONTENTS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid content: &lt;</span><span class="si">{</span><span class="n">usecontent</span><span class="si">}</span><span class="s2">&gt;! &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Valid content: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ALLOWED_CONTENTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;outgoing content is set to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usecontent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">content_specific</span><span class="p">:</span>
        <span class="n">_content_validate</span><span class="p">(</span><span class="n">usecontent</span><span class="p">,</span> <span class="n">content_specific</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;content has no extra information&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">usecontent</span><span class="p">,</span> <span class="n">content_specific</span>


<span class="k">def</span> <span class="nf">_content_validate</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;starting staticmethod _data_process_content_validate&quot;</span><span class="p">)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">ALLOWED_CONTENTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot validate content for &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;name: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">replace_deprecated</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">wanted_type</span> <span class="o">=</span> <span class="n">valid</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">wanted_type</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid type for &lt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&gt; with value &lt;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&gt;, not of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;type &lt;</span><span class="si">{</span><span class="n">wanted_type</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">DEPRECATED_CONTENTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> is deprecated, issue warning&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">replaced_by</span> <span class="o">=</span> <span class="n">DEPRECATED_CONTENTS</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;replaced_by&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Content </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is deprecated. &quot;</span>

            <span class="k">if</span> <span class="n">replaced_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Please use </span><span class="si">{</span><span class="n">replaced_by</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="n">replace_deprecated</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">replaced_by</span><span class="p">})</span>

            <span class="n">warn</span><span class="p">(</span>
                <span class="n">message</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key &lt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&gt; is not valid for &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">replaced_by</span> <span class="ow">in</span> <span class="n">replace_deprecated</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replacing deprecated </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">replaced_by</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="n">replaced_by</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updated fields is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

    <span class="n">required</span> <span class="o">=</span> <span class="n">CONTENTS_REQUIRED</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">required</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rlist is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rlist</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fields is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">rkey</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">rlist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rkey not in fields.keys(): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rkey: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rkey</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;fields.keys(): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">rkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The subkey &lt;</span><span class="si">{</span><span class="n">rkey</span><span class="si">}</span><span class="s2">&gt; is required for content &lt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&gt; &quot;</span><span class="p">,</span>
                <span class="s2">&quot;but is not found&quot;</span><span class="p">,</span>
            <span class="p">)</span>


<span class="c1"># ======================================================================================</span>
<span class="c1"># Public function to read/load assosiated metadata given a file (e.g. a map file)</span>
<span class="c1"># ======================================================================================</span>


<div class="viewcode-block" id="read_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.read_metadata">[docs]</a><span class="k">def</span> <span class="nf">read_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the metadata as a dictionary given a filename.</span>

<span class="sd">    If the filename is e.g. /some/path/mymap.gri, the assosiated metafile</span>
<span class="sd">    will be /some/path/.mymap.gri.yml (or json?)</span>

<span class="sd">    Args:</span>
<span class="sd">        filename: The full path filename to the data-object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with metadata read from the assiated metadata file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_utils_read_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<span class="c1"># ======================================================================================</span>
<span class="c1"># ExportData, public class</span>
<span class="c1"># ======================================================================================</span>


<div class="viewcode-block" id="ExportData"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ExportData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for exporting data with rich metadata in FMU.</span>

<span class="sd">    This class sets up the general metadata content to be applied in export. The idea is</span>
<span class="sd">    that one ExportData instance can be re-used for several similar export() jobs. For</span>
<span class="sd">    example::</span>

<span class="sd">        edata = dataio.ExportData(</span>
<span class="sd">            config=CFG, content=&quot;depth&quot;, unit=&quot;m&quot;, vertical_domain={&quot;depth&quot;: &quot;msl&quot;},</span>
<span class="sd">            timedata=None, is_prediction=True, is_observation=False,</span>
<span class="sd">            tagname=&quot;faultlines&quot;, workflow=&quot;rms structural model&quot;,</span>
<span class="sd">        )</span>

<span class="sd">        for name in [&quot;TopOne&quot;, TopTwo&quot;, &quot;TopThree&quot;]:</span>
<span class="sd">            poly = xtgeo.polygons_from_roxar(PRJ, hname, POL_FOLDER)</span>

<span class="sd">            out = ed.export(poly, name=name)</span>

<span class="sd">    Almost all keyword settings like ``name``, ``tagname`` etc can be set in both the</span>
<span class="sd">    ExportData instance and directly in the ``generate_metadata`` or ``export()``</span>
<span class="sd">    function, to provide flexibility for different use cases. If both are set, the</span>
<span class="sd">    ``export()`` setting will win followed by ``generate_metadata() and finally</span>
<span class="sd">    ExportData()``.</span>

<span class="sd">    A note on &#39;pwd&#39; and &#39;rootpath&#39; and &#39;casepath&#39;: The &#39;pwd&#39; is the process working</span>
<span class="sd">    directory, which is folder where the process (script) starts. The &#39;rootpath&#39; is the</span>
<span class="sd">    folder from which relative file names are relative to and is normally auto-detected.</span>
<span class="sd">    The user can however force set the &#39;actual&#39; rootpath by providing the input</span>
<span class="sd">    `casepath`. In case of running a RMS project interactive on disk::</span>

<span class="sd">        /project/foo/resmod/ff/2022.1.0/rms/model                   &lt;&lt; pwd</span>
<span class="sd">        /project/foo/resmod/ff/2022.1.0/                            &lt;&lt; rootpath</span>

<span class="sd">        A file:</span>

<span class="sd">        /project/foo/resmod/ff/2022.1.0/share/results/maps/xx.gri   &lt;&lt; example absolute</span>
<span class="sd">                                        share/results/maps/xx.gri   &lt;&lt; example relative</span>

<span class="sd">    When running an ERT2 forward job using a normal ERT job (e.g. a script)::</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2                      &lt;&lt; pwd</span>
<span class="sd">        /scratch/nn/case                                            &lt;&lt; rootpath</span>

<span class="sd">        A file:</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; absolute</span>
<span class="sd">                         realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; relative</span>

<span class="sd">    When running an ERT2 forward job but here executed from RMS::</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2/rms/model            &lt;&lt; pwd</span>
<span class="sd">        /scratch/nn/case                                            &lt;&lt; rootpath</span>

<span class="sd">        A file:</span>

<span class="sd">        /scratch/nn/case/realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; absolute</span>
<span class="sd">                         realization-44/iter-2/share/results/maps/xx.gri  &lt;&lt; relative</span>


<span class="sd">    Args:</span>
<span class="sd">        access_ssdl: Optional. A dictionary that will overwrite or append</span>
<span class="sd">             to the default ssdl settings read from the config. Example:</span>
<span class="sd">            ``{&quot;access_level&quot;: &quot;restricted&quot;, &quot;rep_include&quot;: False}``</span>

<span class="sd">        casepath: To override the automatic and actual ``rootpath``. Absolute path to</span>
<span class="sd">            the case root. If not provided, the rootpath will be attempted parsed from</span>
<span class="sd">            the file structure or by other means. See also fmu_context, where &quot;case&quot;</span>
<span class="sd">            may need an explicit casepath!</span>

<span class="sd">        config: Required in order to produce valid metadata, either as key (here) or</span>
<span class="sd">            through an environment variable. A dictionary with static settings.</span>
<span class="sd">            In the standard case this is read from FMU global variables</span>
<span class="sd">            (via fmuconfig). The dictionary must contain some</span>
<span class="sd">            predefined main level keys to work with fmu-dataio. If the key is missing or</span>
<span class="sd">            key value is None, then it will look for the environment variable</span>
<span class="sd">            FMU_GLOBAL_CONFIG to detect the file. If no success in finding the file, a</span>
<span class="sd">            UserWarning is made. If both a valid config is provided and</span>
<span class="sd">            FMU_GLOBAL_CONFIG is provided in addition, the latter will be used.</span>
<span class="sd">            Note that this key shall be set while initializing the instance, ie. it</span>
<span class="sd">            cannot be used in ``generate_metadata()`` or ``export()``.</span>
<span class="sd">            Note also: If missing or empty, export() may still be done, but without a</span>
<span class="sd">            metadata file (this feature may change in future releases).</span>

<span class="sd">        content: Optional, default is &quot;depth&quot;. Is a string or a dictionary with one key.</span>
<span class="sd">            Example is &quot;depth&quot; or {&quot;fluid_contact&quot;: {&quot;xxx&quot;: &quot;yyy&quot;, &quot;zzz&quot;: &quot;uuu&quot;}}.</span>
<span class="sd">            Content is checked agains a white-list for validation!</span>

<span class="sd">        fmu_context: In normal forward models, the fmu_context is ``realization`` which</span>
<span class="sd">            is default and will put data per realization. Other contexts may be ``case``</span>
<span class="sd">            which will put data relative to the case root (see also casepath). Another</span>
<span class="sd">            important context is &quot;preprocessed&quot; which will output to a dedicated</span>
<span class="sd">            &quot;preprocessed&quot; folder instead, and metadata will be partially re-used in</span>
<span class="sd">            an ERT model run. If a non-FMU run is detected (e.g. you run from project),</span>
<span class="sd">            fmu-dataio will detect that and set actual context to None as fall-back</span>
<span class="sd">            (unless preprocessed is specified). If value is &quot;preprocessed&quot;, see also</span>
<span class="sd">            ``reuse_metadata`` key.</span>

<span class="sd">        description: A multiline description of the data either as a string or a list</span>
<span class="sd">            of strings.</span>

<span class="sd">        display_name: Optional, set name for clients to use when visualizing.</span>

<span class="sd">        forcefolder: This setting shall only be used as exception, and will make it</span>
<span class="sd">            possible to output to a non-standard folder. A ``/`` in front will indicate</span>
<span class="sd">            an absolute path*; otherwise it will be relative to casepath or rootpath, as</span>
<span class="sd">            dependent on the both fmu_context and the is_observations boolean value. A</span>
<span class="sd">            typical use-case is forcefolder=&quot;seismic&quot; which will replace the &quot;cubes&quot;</span>
<span class="sd">            standard folder for Cube output with &quot;seismics&quot;. Use with care and avoid if</span>
<span class="sd">            possible! (*) For absolute paths, the class variable</span>
<span class="sd">            allow_forcefolder_absolute must set to True.</span>

<span class="sd">        grid_model: Currently allowed but planned for deprecation</span>

<span class="sd">        include_index: This applies to Pandas (table) data only, and if True then the</span>
<span class="sd">            index column will be exported. Deprecated, use class variable</span>
<span class="sd">            ``table_include_index`` instead</span>

<span class="sd">        is_prediction: True (default) if model prediction data</span>

<span class="sd">        is_observation: Default is False. If True, then disk storage will be on the</span>
<span class="sd">            &quot;share/observations&quot; folder, otherwise on share/result. An exception arise</span>
<span class="sd">            if fmu_context is &quot;preprocessed&quot;, then the folder will be set to</span>
<span class="sd">            &quot;share/processed&quot; irrespective the value of is_observation.</span>

<span class="sd">        name: Optional but recommended. The name of the object. If not set it is tried</span>
<span class="sd">            to be inferred from the xtgeo/pandas/... object. The name is then checked</span>
<span class="sd">            towards the stratigraphy list, and name is replaced with official</span>
<span class="sd">            stratigraphic name if found in static metadata `stratigraphy`. For example,</span>
<span class="sd">            if &quot;TopValysar&quot; is the model name and the actual name is &quot;Valysar Top Fm.&quot;</span>
<span class="sd">            that latter name will be used.</span>

<span class="sd">        parent: Optional. This key is required for datatype GridProperty, and</span>
<span class="sd">            refers to the name of the grid geometry.</span>

<span class="sd">        realization: Optional, default is -999 which means that realization shall be</span>
<span class="sd">            detected automatically from the FMU run. Can be used to override in rare</span>
<span class="sd">            cases. If so, numbers must be &gt;= 0</span>

<span class="sd">        reuse_metadata_rule: This input is None or a string describing rule for reusing</span>
<span class="sd">            metadata. Default is None, but if the input is a file string or object with</span>
<span class="sd">            already valid metadata, then it is assumed to be &quot;preprocessed&quot;, which</span>
<span class="sd">            merges the metadata after predefined rules.</span>

<span class="sd">        runpath: TODO! Optional and deprecated. The relative location of the current run</span>
<span class="sd">            root. Optional and will in most cases be auto-detected, assuming that FMU</span>
<span class="sd">            folder conventions are followed. For an ERT run e.g.</span>
<span class="sd">            /scratch/xx/nn/case/realization-0/iter-0/. while in a revision at project</span>
<span class="sd">            disc it will the revision root e.g. /project/xx/resmod/ff/21.1.0/.</span>

<span class="sd">        subfolder: It is possible to set one level of subfolders for file output.</span>
<span class="sd">            The input should only accept a single folder name, i.e. no paths. If paths</span>
<span class="sd">            are present, a deprecation warning will be raised.</span>

<span class="sd">        tagname: This is a short tag description which be be a part of file name.</span>

<span class="sd">        timedata: If given, a list of lists with dates, .e.g.</span>
<span class="sd">            [[20200101, &quot;monitor&quot;], [20180101, &quot;base&quot;]] or just [[2021010]]. The output</span>
<span class="sd">            to metadata will from version 0.9 be different (API change)</span>

<span class="sd">        verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">            in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;, &quot;DEBUG&quot;. Default is</span>
<span class="sd">            &quot;CRITICAL&quot;.</span>

<span class="sd">        vertical_domain: This is dictionary with a key and a reference e.g.</span>
<span class="sd">            {&quot;depth&quot;: &quot;msl&quot;} which is default if missing.</span>

<span class="sd">        workflow: Short tag desciption of workflow (as description)</span>

<span class="sd">        undef_is_zero: Flags that nans should be considered as zero in aggregations</span>


<span class="sd">    .. note:: Comment on time formats</span>

<span class="sd">        If two dates are present (i.e. the element represents a difference, the input</span>
<span class="sd">        time format is on the form::</span>

<span class="sd">            timedata: [[20200101, &quot;monitor&quot;], [20180101, &quot;base&quot;]]</span>

<span class="sd">        Hence the last data (monitor) usually comes first.</span>

<span class="sd">        In the new version this will shown in metadata files as where the oldest date is</span>
<span class="sd">        shown as t0::</span>

<span class="sd">            data:</span>
<span class="sd">              t0:</span>
<span class="sd">                value: 2018010T00:00:00</span>
<span class="sd">                description: base</span>
<span class="sd">              t1:</span>
<span class="sd">                value: 202020101T00:00:00</span>
<span class="sd">                description: monitor</span>

<span class="sd">        The output files will be on the form: somename--t1_t0.ext</span>

<span class="sd">    .. note:: Using config from file</span>

<span class="sd">        Optionally, the keys can be stored in a yaml file as argument, and you can let</span>
<span class="sd">        the environment variable FMU_DATAIO_CONFIG point to that file. This can e.g.</span>
<span class="sd">        make it possible for ERT jobs to point to external input config&#39;s. For example::</span>

<span class="sd">            export FMU_DATAIO_CONFIG=&quot;/path/to/mysettings.yml&quot;</span>
<span class="sd">            export FMU_GLOBAL_CONFIG=&quot;/path/to/global_variables.yml&quot;</span>

<span class="sd">        In python:</span>

<span class="sd">            eda = ExportData()</span>
<span class="sd">            eda.export(obj)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># This role for this class is to be:</span>
    <span class="c1"># - public (end user) interface</span>
    <span class="c1"># - collect the full settings from global config, user keys and class variables</span>
    <span class="c1"># - process and validate these settings</span>
    <span class="c1"># - establish PWD and rootpath</span>
    <span class="c1">#</span>
    <span class="c1"># Then other classes will further do the detailed metadata processing, cf _MetaData</span>
    <span class="c1"># and subsequent classes called by _MetaData</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>

    <span class="c1"># class variables</span>
    <span class="n">allow_forcefolder_absolute</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">arrow_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;arrow&quot;</span>
    <span class="n">case_folder</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;share/metadata&quot;</span>
    <span class="n">createfolder</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">cube_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;segy&quot;</span>
    <span class="n">filename_timedata_reverse</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># reverse order output file name</span>
    <span class="n">grid_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;roff&quot;</span>
    <span class="n">include_ert2jobs</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># if True, include jobs.json from ERT2</span>
    <span class="n">legacy_time_format</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">meta_format</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span>
    <span class="n">polygons_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>  <span class="c1"># or use &quot;csv|xtgeo&quot;</span>
    <span class="n">points_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>  <span class="c1"># or use &quot;csv|xtgeo&quot;</span>
    <span class="n">surface_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;irap_binary&quot;</span>
    <span class="n">table_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
    <span class="n">dict_fformat</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
    <span class="n">table_include_index</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">verifyfolder</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">_inside_rms</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># developer only! if True pretend inside RMS</span>

    <span class="c1"># input keys (alphabetic)</span>
    <span class="n">access_ssdl</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">aggregation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">casepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">depth_reference</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;msl&quot;</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">display_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fmu_context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;realization&quot;</span>
    <span class="n">forcefolder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">grid_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">is_observation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_prediction</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">undef_is_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">realization</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
    <span class="n">reuse_metadata_rule</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">runpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">subfolder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">tagname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">timedata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">verbosity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span>
    <span class="n">vertical_domain</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">workflow</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">table_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># some keys that are modified version of input, prepended with _use</span>
    <span class="n">_usecontent</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_usecontext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_usefmtflag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># storing resulting state variables for instance, non-public:</span>
    <span class="n">_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_pwd</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_config_is_valid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># &lt;&lt; NB! storing ACTUAL casepath:</span>
    <span class="n">_rootpath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running __post_init__ ExportData&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Global config is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prettyprint_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>

        <span class="c1"># set defaults for mutable keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_domain</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="s2">&quot;msl&quot;</span><span class="p">}</span>

        <span class="c1"># if input is provided as an ENV variable pointing to a YAML file; will override</span>
        <span class="k">if</span> <span class="n">SETTINGS_ENVNAME</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">external_input</span> <span class="o">=</span> <span class="n">some_config_from_env</span><span class="p">(</span><span class="n">SETTINGS_ENVNAME</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">external_input</span><span class="p">:</span>
                <span class="c1"># derive legal input from dataclass signature</span>
                <span class="n">annots</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">legals</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">annots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">external_input</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">_validate_variable</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">legals</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;verbosity&quot;</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span> <span class="o">=</span> <span class="n">_check_global_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span>
        <span class="p">)</span>

        <span class="c1"># global config which may be given as env variable -&gt; a file; will override</span>
        <span class="k">if</span> <span class="n">GLOBAL_ENVNAME</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">theconfig</span> <span class="o">=</span> <span class="n">some_config_from_env</span><span class="p">(</span><span class="n">GLOBAL_ENVNAME</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">theconfig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span> <span class="o">=</span> <span class="n">_check_global_config</span><span class="p">(</span>
                <span class="n">theconfig</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">theconfig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">theconfig</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_content_key</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validate FMU context which is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fmucontext_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_globalconfig_from_settings</span><span class="p">()</span>

        <span class="c1"># check state of global config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span> <span class="o">=</span> <span class="n">_check_global_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_establish_pwd_rootpath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_deprecations_or_notimplemented</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FMU context is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ran __post_init__&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_show_deprecations_or_notimplemented</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Warn on deprecated keys or on stuff not implemented yet.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runpath</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;runpath&#39; key has currently no function. It will be evaluated for &quot;</span>
                <span class="s2">&quot;removal in fmu-dataio version 2. Use &#39;casepath&#39; instead!&quot;</span><span class="p">,</span>
                <span class="ne">PendingDeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_model</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;grid_model&#39; key has currently no function. It will be evaluated &quot;</span>
                <span class="s2">&quot;for removal in fmu-dataio version 2.&quot;</span><span class="p">,</span>
                <span class="ne">PendingDeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_content_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the given &#39;content&#39; input.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_usecontent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_content_specific</span> <span class="o">=</span> <span class="n">_check_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_fmucontext_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the given &#39;fmu_context&#39; input.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_FMU_CONTEXTS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ALLOWED_FMU_CONTEXTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;It seems like &#39;fmu_context&#39; value is illegal! &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Allowed entries are: in list:</span><span class="se">\n</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_fmt_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># treat special handling of &quot;xtgeo&quot; in format name:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_fformat</span> <span class="o">==</span> <span class="s2">&quot;csv|xtgeo&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons_fformat</span> <span class="o">==</span> <span class="s2">&quot;csv|xtgeo&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_usefmtflag</span> <span class="o">=</span> <span class="s2">&quot;xtgeo&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using flag format: &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usefmtflag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_check_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update instance settings (properties) from other routines.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Try new settings </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">)</span>

        <span class="c1"># derive legal input from dataclass signature</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">legals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">annots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>
        <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">in</span> <span class="n">legals</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">legals</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>  <span class="c1"># config cannot be updated</span>

        <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">in</span> <span class="n">newsettings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot have &#39;config&#39; outside instance initialization&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">newsettings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_validate_variable</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">legals</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s2">&quot;verbosity&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New setting OK for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_show_deprecations_or_notimplemented</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_content_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fmucontext_key</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Validate FMU context which is now </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_globalconfig_from_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A few user settings may update/append the global config directly.&quot;&quot;&quot;</span>
        <span class="n">newglobals</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_ssdl</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;ssdl&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]:</span>
                <span class="n">newglobals</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">][</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">newglobals</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">][</span><span class="s2">&quot;ssdl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access_ssdl</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Updated global config&#39;s access.ssdl value: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newglobals</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">newglobals</span>

    <span class="k">def</span> <span class="nf">_establish_pwd_rootpath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish state variables pwd and the (initial) rootpath.</span>

<span class="sd">        The self._pwd stores the process working directory, i.e. the folder</span>
<span class="sd">        from which the process is ran</span>

<span class="sd">        The self._rootpath stores the folder from which is the base root for all</span>
<span class="sd">        relative output files. This rootpath may be dependent on if this is a FMU run</span>
<span class="sd">        or just an interactive run.</span>

<span class="sd">        Hence this &#39;initial&#39; rootpath can be updated later!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Establish pwd and actual casepath, inside RMS flag is </span><span class="si">%s</span><span class="s2"> (actual: </span><span class="si">%s</span><span class="s2">))&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inside_rms</span><span class="p">,</span>
            <span class="n">INSIDE_RMS</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="c1"># fmu_context 1: Running RMS, we are in conventionally in rootpath/rms/model</span>
        <span class="c1"># fmu_context 2: ERT FORWARD_JOB, at case = rootpath=RUNPATH/../../. level</span>
        <span class="c1"># fmu_context 3: ERT WORKFLOW_JOB, running somewhere/anywhere else</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">casepath</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casepath</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casepath</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The casepath is hard set as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inside_rms</span> <span class="ow">or</span> <span class="n">INSIDE_RMS</span> <span class="ow">or</span> <span class="s2">&quot;RUN_DATAIO_EXAMPLES&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">/</span> <span class="s2">&quot;../../.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Run from inside RMS (or pretend)&quot;</span><span class="p">)</span>
                <span class="c1"># BUG(?): Should be ExportData._inside_rms ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inside_rms</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore[misc]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_usecontext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmu_context</span>  <span class="c1"># may change later!</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pwd:        </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;rootpath:   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_obj_if_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;When obj is file-like, it must be checked + assume preprocessed.</span>

<span class="sd">        In addition, if preprocessed, derive the name, tagname, subfolder if present and</span>
<span class="sd">        those are not set already.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reuse_metadata_rule</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reuse_metadata_rule</span> <span class="o">=</span> <span class="s2">&quot;preprocessed&quot;</span>

            <span class="n">currentmeta</span> <span class="o">=</span> <span class="n">read_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;_preprocessed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">currentmeta</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;The special entry for preprocessed data &lt;_preprocessed&gt; is&quot;</span>
                    <span class="s2">&quot;missing in the metadata. A possible solution is to rerun the&quot;</span>
                    <span class="s2">&quot;preprocessed export.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span> <span class="ow">and</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tagname&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span> <span class="o">=</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">][</span><span class="s2">&quot;tagname&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subfolder</span> <span class="ow">and</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subfolder&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subfolder</span> <span class="o">=</span> <span class="n">currentmeta</span><span class="p">[</span><span class="s2">&quot;_preprocessed&quot;</span><span class="p">][</span><span class="s2">&quot;subfolder&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">obj</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Public methods:</span>
    <span class="c1"># ==================================================================================</span>

<div class="viewcode-block" id="ExportData.generate_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.generate_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">generate_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">compute_md5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and return the complete metadata for a provided object.</span>

<span class="sd">        An object may be a map, 3D grid, cube, table, etc which is of a known and</span>
<span class="sd">        supported type.</span>

<span class="sd">        Examples of such known types are XTGeo objects (e.g. a RegularSurface),</span>
<span class="sd">        a Pandas Dataframe, a PyArrow table, etc.</span>

<span class="sd">        If the key ``reuse_metadata_rule`` is applied with legal value, the object may</span>
<span class="sd">        also be a reference to a file with existing metadata which then will be re-used.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: XTGeo instance, a Pandas Dataframe instance or other supported object.</span>
<span class="sd">            compute_md5: If True, compute a MD5 checksum for the exported file.</span>
<span class="sd">            **kwargs: For other arguments, see ExportData() input keys. If they</span>
<span class="sd">                exist both places, this function will override!</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with all metadata.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the ``compute_md5`` key is False, the ``file.checksum_md5`` will be</span>
<span class="sd">            empty. If true, the MD5 checksum will be generated based on export to</span>
<span class="sd">            a temporary file, which may be time-consuming if the file is large.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generate metadata...&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;KW args </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_check_settings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_globalconfig_from_settings</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span> <span class="o">=</span> <span class="n">_check_global_config</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;warn&quot;</span>
        <span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_obj_if_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_establish_pwd_rootpath</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_content_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_fmt_flag</span><span class="p">()</span>

        <span class="n">metaobj</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">_MetaData</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="n">compute_md5</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metaobj</span><span class="o">.</span><span class="n">generate_export_metadata</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metaobj</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The metadata are now ready!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExportData.export"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.ExportData.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">return_symlink</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export data objects of &#39;known&#39; type to FMU storage solution with metadata.</span>

<span class="sd">        This function will also collect the data spesific class metadata. For &quot;classic&quot;</span>
<span class="sd">        files, the metadata will be stored i a YAML file with same name stem as the</span>
<span class="sd">        data, but with a . in front and &quot;yml&quot; and suffix, e.g.::</span>

<span class="sd">            top_volantis--depth.gri</span>
<span class="sd">            .top_volantis--depth.gri.yml</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: XTGeo instance, a Pandas Dataframe instance or other supported object.</span>
<span class="sd">            return_symlink: If fmu_context is &#39;case_symlink_realization&#39; then the link</span>
<span class="sd">                adress will be returned if this is True; otherwise the physical file</span>
<span class="sd">                path will be returned.</span>
<span class="sd">            **kwargs: For other arguments, see ExportData() input keys. If they</span>
<span class="sd">                exist both places, this function will override!</span>

<span class="sd">        Returns:</span>
<span class="sd">            String: full path to exported item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table_index&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">])</span>
        <span class="n">metafile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span><span class="p">)</span>

        <span class="n">useflag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_include_index</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usefmtflag</span>
        <span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_obj_if_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Export to file and compute MD5 sum, using flag: &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="n">useflag</span><span class="p">)</span>
        <span class="c1"># inject md5 checksum in metadata</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;checksum_md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_file_compute_checksum_md5</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span>
            <span class="n">outfile</span><span class="p">,</span>
            <span class="n">outfile</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span>
            <span class="n">flag</span><span class="o">=</span><span class="n">useflag</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># BUG(?): Looks buggy, if flag is bool export_file will blow up.</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual file is:   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config_is_valid</span><span class="p">:</span>
            <span class="n">export_metadata_file</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">savefmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_format</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata file is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metafile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Data will be exported, but without metadata.&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

        <span class="c1"># generate symlink if requested</span>
        <span class="n">outfile_target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;absolute_path_symlink&quot;</span><span class="p">):</span>
            <span class="n">outfile_target</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path_symlink&quot;</span><span class="p">])</span>
            <span class="n">outfile_source</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">])</span>
            <span class="n">create_symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outfile_source</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile_target</span><span class="p">))</span>
            <span class="n">metafile_target</span> <span class="o">=</span> <span class="n">outfile_target</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span><span class="p">)</span>
            <span class="n">create_symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metafile</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metafile_target</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">if</span> <span class="n">return_symlink</span> <span class="ow">and</span> <span class="n">outfile_target</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile_target</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div></div>


<span class="c1"># ######################################################################################</span>
<span class="c1"># InitializeCase.</span>
<span class="c1">#</span>
<span class="c1"># The InitializeCase is used for making the case matadata prior to any other actions,</span>
<span class="c1"># e.g. forward jobs. However, case metadata file may already exist, and in that case</span>
<span class="c1"># this class should only emit a message or warning</span>
<span class="c1"># ######################################################################################</span>


<div class="viewcode-block" id="InitializeCase"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">InitializeCase</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Instantate InitializeCase object.</span>

<span class="sd">    In ERT this is typically ran as an hook workflow in advance.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: A configuration dictionary. In the standard case this is read</span>
<span class="sd">            from FMU global variables (via fmuconfig). The dictionary must contain</span>
<span class="sd">            some predefined main level keys. If config is None or the env variable</span>
<span class="sd">            FMU_GLOBAL_CONFIG pointing to a file is provided, then it will attempt to</span>
<span class="sd">            parse that file instead.</span>
<span class="sd">        rootfolder: To override the automatic and actual ``rootpath``. Absolute path to</span>
<span class="sd">            the case root, including case name. If not provided (which is not</span>
<span class="sd">            recommended), the rootpath will be attempted parsed from the file structure</span>
<span class="sd">            or by other means.</span>
<span class="sd">        casename: Name of case (experiment)</span>
<span class="sd">        caseuser: Username provided</span>
<span class="sd">        restart_from: ID of eventual restart (deprecated)</span>
<span class="sd">        description: Description text as string or list of strings.</span>
<span class="sd">        verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">            in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># class variables</span>
    <span class="n">meta_format</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span>

    <span class="c1"># instance</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="n">rootfolder</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">casename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">caseuser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">restart_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">verbosity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span>

    <span class="n">_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_metafile</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_pwd</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_casepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">or</span> <span class="n">GLOBAL_ENVNAME</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">cnf</span> <span class="o">=</span> <span class="n">some_config_from_env</span><span class="p">(</span><span class="n">GLOBAL_ENVNAME</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">cnf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">cnf</span>

        <span class="c1"># For this class, the global config must be valid; hence error if not</span>
        <span class="n">_check_global_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ran __post_init__ for InitializeCase&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update instance settings (properties) from other routines.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Try new settings </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">)</span>

        <span class="c1"># derive legal input from dataclass signature</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">legals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">annots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">newsettings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s2">&quot;restart_from&quot;</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;restart_from&#39; argument is deprecated and will be removed in &quot;</span>
                    <span class="s2">&quot;a future version. Please refer to the fmu-dataio documentation &quot;</span>
                    <span class="s2">&quot;for information on how to record information about restart &quot;</span>
                    <span class="s2">&quot;source.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">_validate_variable</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">legals</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s2">&quot;verbosity&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New setting OK for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_establish_pwd_casepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish state variables pwd and casepath.</span>

<span class="sd">        See ExportData&#39;s method but this is much simpler (e.g. no RMS context)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootfolder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootfolder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Emit UserWarning&quot;</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The rootfolder is defaulted, but it is strongly recommended to give &quot;</span>
                <span class="s2">&quot;an explicit rootfolder&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set PWD (case): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pwd</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set rootpath (case): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_already_metadata_or_create_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created rootpath (case) </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span><span class="p">)</span>

        <span class="n">metadata_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casepath</span> <span class="o">/</span> <span class="s2">&quot;share/metadata&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metafile</span> <span class="o">=</span> <span class="n">metadata_path</span> <span class="o">/</span> <span class="s2">&quot;fmu_case.yml&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The requested metafile is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metafile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Forcing a new metafile&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metafile</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">metadata_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Public methods:</span>
    <span class="c1"># ==================================================================================</span>

<div class="viewcode-block" id="InitializeCase.generate_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase.generate_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">generate_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate case metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            force: Overwrite existing case metadata if True. Default is False. If force</span>
<span class="sd">                is False and case metadata already exists, a warning will issued and</span>
<span class="sd">                None will be returned.</span>
<span class="sd">            skip_null: Fields with None/missing values will be skipped if True (default)</span>
<span class="sd">            **kwargs: See InitializeCase() arguments; initial will be overrided by</span>
<span class="sd">                settings here.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with case metadata or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_settings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_establish_pwd_casepath</span><span class="p">()</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_already_metadata_or_create_folder</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The metadatafile already exists!&quot;</span><span class="p">)</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The metadata file already exist! Keep this file instead! &quot;</span>
                <span class="s2">&quot;To make a new case metadata file, delete the old case or use the &quot;</span>
                <span class="s2">&quot;&#39;force&#39; option&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">default_meta_dollars</span><span class="p">()</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;case&quot;</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;masterdata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">generate_meta_masterdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># only asset, not ssdl</span>
        <span class="n">access</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">generate_meta_access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">access</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">][</span><span class="s2">&quot;asset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access</span><span class="p">[</span><span class="s2">&quot;asset&quot;</span><span class="p">]</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="n">mcase</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mcase</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">casename</span>
        <span class="n">mcase</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="n">mcase</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">caseuser</span><span class="p">}</span>  <span class="c1"># type: ignore</span>

        <span class="n">mcase</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">mcase</span><span class="p">[</span><span class="s2">&quot;restart_from&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_from</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_metadata</span><span class="o">.</span><span class="n">generate_meta_tracklog</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">skip_null</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">drop_nones</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The case metadata are now ready!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span></div>

    <span class="c1"># alias</span>
    <span class="n">generate_case_metadata</span> <span class="o">=</span> <span class="n">generate_metadata</span>

<div class="viewcode-block" id="InitializeCase.export"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.InitializeCase.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export case metadata to file.</span>

<span class="sd">        Args:</span>
<span class="sd">            force: Overwrite existing case metadata if True. Default is False. If force</span>
<span class="sd">                is False and case metadata already exists, a warning will issued and</span>
<span class="sd">                None will be returned.</span>
<span class="sd">            skip_null: Fields with None/missing values will be skipped if True (default)</span>
<span class="sd">            **kwargs: See InitializeCase() arguments; initial will be overrided by</span>
<span class="sd">                settings here.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Full path of metadata file or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_case_metadata</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">skip_null</span><span class="o">=</span><span class="n">skip_null</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">export_metadata_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metafile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span> <span class="n">savefmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_format</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;METAFILE </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metafile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;The metadatafile exists already. use &#39;force&#39; or delete the &quot;</span>
                <span class="s2">&quot;current case folder if a new metadata are requested.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metafile</span><span class="p">)</span></div></div>


<span class="c1"># ######################################################################################</span>
<span class="c1"># AggregatedData</span>
<span class="c1">#</span>
<span class="c1"># The AggregatedData is used for making the aggregations from existing data that already</span>
<span class="c1"># have valid metadata, i.e. made from ExportData.</span>
<span class="c1">#</span>
<span class="c1"># Hence this is actually quite different and simpler than ExportData(), which</span>
<span class="c1"># needed a lot of info as FmuProvider, FileProvider, ObjectData etc. Here most these</span>
<span class="c1"># already known from the input.</span>
<span class="c1">#</span>
<span class="c1"># For aggregations, the id is normally given as an argument by the external process, and</span>
<span class="c1"># by that, be able to give a group of aggregations the same id.</span>
<span class="c1">#</span>
<span class="c1"># ######################################################################################</span>


<div class="viewcode-block" id="AggregatedData"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.AggregatedData">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AggregatedData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Instantate AggregatedData object.</span>

<span class="sd">    Args:</span>
<span class="sd">        aggregation_id: Give an explicit ID for the aggregation. If None, an ID will be</span>
<span class="sd">        made based on existing realization uuids.</span>
<span class="sd">        casepath: The root folder to the case, default is None. If None, the casepath</span>
<span class="sd">            is derived from the first input metadata paths (cf. ``source_metadata``) if</span>
<span class="sd">            possible. If given explicitly, the physical casepath folder must exist in</span>
<span class="sd">            advance, otherwise a ValueError will be raised.</span>
<span class="sd">        source_metadata: A list of individual metadata dictionarys, coming from the</span>
<span class="sd">            valid metadata per input element that forms the aggregation.</span>
<span class="sd">        operation: A string that describes the operation, e.g. &quot;mean&quot;. This is</span>
<span class="sd">            mandatory and there is no default.</span>
<span class="sd">        verbosity: Is logging/message level for this module. Input as</span>
<span class="sd">            in standard python logging; e.g. &quot;WARNING&quot;, &quot;INFO&quot;.</span>
<span class="sd">        tagname: Additional name, as part of file name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># class variable(s)</span>
    <span class="n">meta_format</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span>

    <span class="c1"># instance</span>
    <span class="n">aggregation_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">casepath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">source_metadata</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">tagname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">verbosity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL&quot;</span>

    <span class="n">_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">_metafile</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_aggr_uuid</span><span class="p">(</span><span class="n">uuids</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unless aggregation_id; use existing UUIDs to generate a new UUID.&quot;&quot;&quot;</span>

        <span class="n">stringinput</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">xuuid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uuids</span><span class="p">):</span>
            <span class="n">stringinput</span> <span class="o">+=</span> <span class="n">xuuid</span>

        <span class="k">return</span> <span class="n">uuid_from_string</span><span class="p">(</span><span class="n">stringinput</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update instance settings (properties) from other routines.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Try new settings </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newsettings</span><span class="p">)</span>

        <span class="c1"># derive legal input from dataclass signature</span>
        <span class="n">annots</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">legals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">annots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">newsettings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_validate_variable</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">legals</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s2">&quot;verbosity&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New setting OK for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the paths/filenames for aggregated data.</span>

<span class="sd">        These filenames are constructed a bit different than in a forward job, since we</span>
<span class="sd">        do not now which folder we &#39;are in&#39; when doing aggregations. Could possibly also</span>
<span class="sd">        be in a cloud setting.</span>

<span class="sd">        Hence we use the first input realization as template, e.g.:</span>

<span class="sd">        file:</span>
<span class="sd">           relative_path: realization-33/iter-0/share/results/maps/x.gri</span>
<span class="sd">           absolute_path: /scratch/f/case/realization-33/iter-0/share/results/maps/x.gri</span>

<span class="sd">        And from thet we derive/compose the relative and absolute path for the</span>
<span class="sd">        aggregated data:</span>

<span class="sd">        file:</span>
<span class="sd">           relative_path: iter-0/share/results/maps/aggr.gri</span>
<span class="sd">           absolute_path: /scratch/f/case/iter-0/share/results/maps/aggr.gri</span>

<span class="sd">        The trick is to replace &#39;realization-*&#39; with nothing and create a new file</span>
<span class="sd">        name.</span>

<span class="sd">        -----</span>
<span class="sd">        However, there are also the scenario that absolute_path are missing (e.g. all</span>
<span class="sd">        input realizations are directly made in cloud setting), and we need to</span>
<span class="sd">        account for that:</span>

<span class="sd">        infile:</span>
<span class="sd">           relative_path: realization-33/iter-0/share/results/maps/x.gri</span>
<span class="sd">           absolute_path: none</span>

<span class="sd">        file:</span>
<span class="sd">           relative_path: iter-0/share/results/maps/aggr.gri</span>
<span class="sd">           absolute_path: none</span>

<span class="sd">        -----</span>
<span class="sd">        Finally, a user given casepath (casepath is not None) should replace the current</span>
<span class="sd">        root part in the files. Like this:</span>

<span class="sd">        infile:</span>
<span class="sd">           relative_path: realization-33/iter-0/share/results/maps/x.gri</span>
<span class="sd">           absolute_path: /scratch/f/case/realization-33/iter-0/share/results/maps/x.gri</span>

<span class="sd">        casepath = /scratch/f/othercase</span>

<span class="sd">        result:</span>
<span class="sd">           relative_path: iter-0/share/results/maps/aggr.gri</span>
<span class="sd">           absolute_path: /scratch/f/othercase/iter-0/share/results/maps/aggrd.gri</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Construct file name for the aggregation...&quot;</span><span class="p">)</span>
        <span class="n">realiname</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;realization&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;relative_path&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First input realization relpath is: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">relpath</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;First input realization abspath is: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">abspath</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">casepath</span><span class="p">:</span>
            <span class="n">casepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">casepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The given casepath </span><span class="si">{</span><span class="n">casepath</span><span class="si">}</span><span class="s2"> does not exist. &quot;</span>
                    <span class="s2">&quot;It must exist in advance!&quot;</span>
                <span class="p">)</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">casepath</span> <span class="o">/</span> <span class="n">relpath</span><span class="p">)</span>

        <span class="n">relpath</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">realiname</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">abspath</span><span class="p">:</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">abspath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">realiname</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">abspath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">suffix</span>
        <span class="n">stem</span> <span class="o">=</span> <span class="n">relpath</span><span class="o">.</span><span class="n">stem</span>

        <span class="n">usename</span> <span class="o">=</span> <span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Input name is not given, will assume &lt;usename&gt;&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span><span class="p">:</span>
            <span class="n">usename</span> <span class="o">=</span> <span class="n">usename</span> <span class="o">+</span> <span class="s2">&quot;--&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span>

        <span class="n">relname</span> <span class="o">=</span> <span class="p">(</span><span class="n">relpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">usename</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="n">absname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">abspath</span><span class="p">:</span>
            <span class="n">absname</span> <span class="o">=</span> <span class="p">(</span><span class="n">abspath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">usename</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New relpath is: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">relname</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New abspath is: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">absname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">relname</span><span class="p">,</span> <span class="n">absname</span>

    <span class="k">def</span> <span class="nf">_generate_aggrd_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">real_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">uuids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">compute_md5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;self.aggregation is </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_id</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregation_id</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_aggr_uuid</span><span class="p">(</span><span class="n">uuids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregation_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;aggregation_id must be a string&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;operation&#39; key has no value&quot;</span><span class="p">)</span>

        <span class="c1"># use first as template but filter away invalid entries first:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">filter_validate_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">relpath</span><span class="p">,</span> <span class="n">abspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_filename</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="c1"># fmu.realization shall not be used</span>
        <span class="k">del</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;realization&quot;</span><span class="p">]</span>

        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;aggregation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;aggregation&quot;</span><span class="p">][</span><span class="s2">&quot;operation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;aggregation&quot;</span><span class="p">][</span><span class="s2">&quot;realization_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_ids</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;aggregation&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregation_id</span>

        <span class="c1"># fmu.context.stage should be &#39;iteration&#39;</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;context&quot;</span><span class="p">][</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;iteration&quot;</span>

        <span class="c1"># next, the new object will trigger update of: &#39;file&#39;, &#39;data&#39; (some fields) and</span>
        <span class="c1"># &#39;tracklog&#39;. The trick is to create an ExportData() instance and just retrieve</span>
        <span class="c1"># the metadata from that, and then blend the needed metadata from here into the</span>
        <span class="c1"># template -&gt; final metadata</span>

        <span class="n">fakeconfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;access&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;access&quot;</span><span class="p">],</span>
            <span class="s2">&quot;masterdata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;masterdata&quot;</span><span class="p">],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>
        <span class="n">etemp</span> <span class="o">=</span> <span class="n">ExportData</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">fakeconfig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">etempmeta</span> <span class="o">=</span> <span class="n">etemp</span><span class="o">.</span><span class="n">generate_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="n">compute_md5</span><span class="p">)</span>

        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etempmeta</span><span class="p">[</span><span class="s2">&quot;tracklog&quot;</span><span class="p">]</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etempmeta</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>  <span class="c1"># actually only use the checksum_md5</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;relative_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
        <span class="n">template</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span> <span class="k">if</span> <span class="n">abspath</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># data section</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">template</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span><span class="p">:</span>
            <span class="n">template</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;tagname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tagname</span>
        <span class="k">if</span> <span class="n">etempmeta</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bbox&quot;</span><span class="p">):</span>
            <span class="n">template</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etempmeta</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">template</span>

    <span class="c1"># ==================================================================================</span>
    <span class="c1"># Public methods:</span>
    <span class="c1"># ==================================================================================</span>

<div class="viewcode-block" id="AggregatedData.generate_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.AggregatedData.generate_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">generate_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">compute_md5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate metadata for the aggregated data.</span>

<span class="sd">        This is a quite different and much simpler operation than the ExportData()</span>
<span class="sd">        version, as here most metadata for each input element are already known. Hence,</span>
<span class="sd">        the metadata for the first element in the input list is used as template.</span>

<span class="sd">        Args:</span>

<span class="sd">            obj: The map, 3D grid, table, etc instance.</span>

<span class="sd">            compute_md5: If True, an md5 sum for the file will be created. This involves</span>
<span class="sd">                a temporary export of the data, and may be time consuming for large</span>
<span class="sd">                data.</span>

<span class="sd">            skip_null: If True (default), None values in putput will be skipped</span>
<span class="sd">            **kwargs: See AggregatedData() arguments; initial will be overridden by</span>
<span class="sd">                settings here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generate metadata for class&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_settings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># get input realization numbers:</span>
        <span class="n">real_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_metadata</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;realization&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
                <span class="n">xuuid</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;fmu&quot;</span><span class="p">][</span><span class="s2">&quot;realization&quot;</span><span class="p">][</span><span class="s2">&quot;uuid&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seems that input config are not valid: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">real_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span>
            <span class="n">uuids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xuuid</span><span class="p">)</span>

        <span class="c1"># first config file as template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_aggrd_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">real_ids</span><span class="p">,</span> <span class="n">uuids</span><span class="p">,</span> <span class="n">compute_md5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_null</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">drop_nones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">)</span></div>

    <span class="c1"># alias method</span>
<div class="viewcode-block" id="AggregatedData.generate_aggregation_metadata"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.AggregatedData.generate_aggregation_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">generate_aggregation_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="n">compute_md5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_null</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias method name, see ``generate_metadata``&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_metadata</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="n">compute_md5</span><span class="p">,</span> <span class="n">skip_null</span><span class="o">=</span><span class="n">skip_null</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AggregatedData.export"><a class="viewcode-back" href="../../apiref/dataio.dataio.html#dataio.dataio.AggregatedData.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export aggregated file with metadata to file.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj: Aggregated object to export, e.g. a XTGeo RegularSurface</span>
<span class="sd">            **kwargs: See AggregatedData() arguments; initial will be overridden by</span>
<span class="sd">                settings here.</span>
<span class="sd">        Returns:</span>
<span class="sd">            String: full path to exported item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_settings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_metadata</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">compute_md5</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">abspath</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;absolute_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                <span class="s2">&quot;The absolute_path is None, hence no export is possible. &quot;</span>
                <span class="s2">&quot;Use the ``casepath`` key to provide a valid absolute path.&quot;</span>
            <span class="p">)</span>

        <span class="n">outfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">metafile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Export to file and compute MD5 sum&quot;</span><span class="p">)</span>
        <span class="c1"># inject the computed md5 checksum in metadata</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">][</span><span class="s2">&quot;checksum_md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_file_compute_checksum_md5</span><span class="p">(</span>
            <span class="n">obj</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">outfile</span><span class="o">.</span><span class="n">suffix</span>
        <span class="p">)</span>

        <span class="n">export_metadata_file</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">savefmt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_format</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Actual file is:   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metadata file is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">metafile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Equinor 2024 (fmu-dataio release 0.1.dev1+g2c13a20).</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>